<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#000000">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>GR Perform - Profilo</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        :root {
            --red: #E63946;
            --black: #000;
            --gray-900: #0A0A0A;
            --gray-800: #111;
            --gray-700: #1A1A1A;
            --gray-600: #222;
            --gray-500: #333;
            --gray-400: #666;
            --gray-300: #888;
            --white: #FFF;
            --green: #00D26A;
            --blue: #007AFF;
            --orange: #FF9500;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--black);
            color: var(--white);
            min-height: 100vh;
            padding-bottom: 100px;
            -webkit-font-smoothing: antialiased;
        }

        /* HEADER */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 20px;
            border-bottom: 1px solid var(--gray-600);
        }

        .header-title {
            font-size: 18px;
            font-weight: 700;
        }

        .header-btn {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: var(--gray-700);
            border: none;
            color: var(--white);
            cursor: pointer;
        }

        /* PROFILE HERO */
        .profile-hero {
            position: relative;
            text-align: center;
            padding: 32px 20px;
            min-height: 280px;
            overflow: hidden;
        }

        .profile-hero-bg {
            position: absolute;
            inset: 0;
            background-size: cover;
            background-position: center top;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .profile-hero-bg.loaded {
            opacity: 0.7;
        }

        .profile-hero-overlay {
            position: absolute;
            inset: 0;
            background: linear-gradient(180deg, rgba(0,0,0,0.1) 0%, rgba(0,0,0,0.4) 70%, rgba(0,0,0,0.95) 100%);
        }

        .profile-hero-content {
            position: relative;
            z-index: 2;
        }

        /* Sport backgrounds - Pexels images */
        .profile-hero-bg.calcio, .profile-hero-bg.football {
            background-image: url('https://images.pexels.com/photos/3797/black-and-white-sport-fight-boxer.jpg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=2');
        }
        .profile-hero-bg.basket, .profile-hero-bg.basketball {
            background-image: url('https://images.pexels.com/photos/3797/black-and-white-sport-fight-boxer.jpg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=2');
        }
        .profile-hero-bg.boxe, .profile-hero-bg.boxing {
            background-image: url('https://images.pexels.com/photos/3797/black-and-white-sport-fight-boxer.jpg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=2');
            background-position: center 20%;
        }

        @media (min-width: 768px) {
            .profile-hero-bg.boxe, .profile-hero-bg.boxing {
                background-position: center 30%;
            }
        }
        .profile-hero-bg.palestra, .profile-hero-bg.fitness, .profile-hero-bg.gym {
            background-image: url('https://images.pexels.com/photos/949132/pexels-photo-949132.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=2');
        }
        .profile-hero-bg.running, .profile-hero-bg.corsa {
            background-image: url('https://images.pexels.com/photos/949132/pexels-photo-949132.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=2');
        }
        .profile-hero-bg.default {
            background-image: url('https://images.pexels.com/photos/949132/pexels-photo-949132.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=2');
        }

        .avatar-container {
            position: relative;
            display: inline-block;
            margin-bottom: 16px;
        }

        .avatar {
            width: 110px;
            height: 110px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--red), #B71C1C);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 38px;
            font-weight: 800;
            overflow: hidden;
            border: 3px solid rgba(255,255,255,0.2);
            box-shadow: 0 8px 32px rgba(0,0,0,0.4);
        }

        .avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .avatar-edit {
            position: absolute;
            bottom: 0;
            right: 0;
            width: 32px;
            height: 32px;
            background: var(--red);
            border-radius: 50%;
            border: 3px solid var(--black);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }

        .avatar-edit input {
            display: none;
        }

        .avatar-edit i {
            font-size: 12px;
        }

        .profile-name {
            font-size: 24px;
            font-weight: 800;
            margin-bottom: 4px;
        }

        .profile-meta {
            color: var(--gray-300);
            font-size: 14px;
            margin-bottom: 16px;
        }

        .level-badge {
            display: inline-flex;
            align-items: center;
            gap: 12px;
            background: var(--gray-700);
            padding: 10px 20px;
            border-radius: 24px;
        }

        .level-icon {
            width: 32px;
            height: 32px;
            background: var(--red);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
        }

        .level-info {
            text-align: left;
        }

        .level-title {
            font-size: 14px;
            font-weight: 700;
        }

        .level-xp {
            font-size: 12px;
            color: var(--gray-300);
        }

        /* STATS GRID */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1px;
            background: var(--gray-600);
            margin: 0 16px 24px;
            border-radius: 16px;
            overflow: hidden;
        }

        .stat-item {
            background: var(--gray-800);
            padding: 16px 8px;
            text-align: center;
        }

        .stat-value {
            font-size: 22px;
            font-weight: 800;
        }

        .stat-value.green { color: var(--green); }
        .stat-value.red { color: var(--red); }
        .stat-value.blue { color: var(--blue); }
        .stat-value.orange { color: var(--orange); }

        .stat-label {
            font-size: 10px;
            color: var(--gray-300);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-top: 4px;
        }

        /* BADGES */
        .badges-section {
            padding: 0 16px 24px;
        }

        .badges-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .badges-title {
            font-size: 12px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--gray-300);
        }

        .badges-count {
            font-size: 12px;
            color: var(--gray-300);
        }

        .badges-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
        }

        .badge-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            cursor: pointer;
        }

        .badge-icon {
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: var(--gray-700);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            margin-bottom: 6px;
            transition: all 0.2s;
            position: relative;
        }

        .badge-item.unlocked .badge-icon {
            background: linear-gradient(135deg, #FFD700, #FFA500);
            box-shadow: 0 4px 16px rgba(255, 215, 0, 0.3);
        }

        .badge-item.locked .badge-icon {
            opacity: 0.4;
            filter: grayscale(1);
        }

        .badge-item.locked .badge-icon::after {
            content: 'üîí';
            position: absolute;
            font-size: 12px;
            bottom: -2px;
            right: -2px;
        }

        .badge-name {
            font-size: 10px;
            font-weight: 600;
            color: var(--gray-300);
            max-width: 70px;
            line-height: 1.2;
        }

        .badge-item.unlocked .badge-name {
            color: var(--white);
        }

        /* Badge Modal */
        .badge-modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.9);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 24px;
        }

        .badge-modal.visible {
            display: flex;
        }

        .badge-modal-content {
            background: var(--gray-800);
            border-radius: 24px;
            padding: 32px;
            text-align: center;
            max-width: 320px;
            animation: badgeModalIn 0.3s ease;
        }

        @keyframes badgeModalIn {
            from { transform: scale(0.8); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        .badge-modal-icon {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background: linear-gradient(135deg, #FFD700, #FFA500);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 48px;
            margin: 0 auto 20px;
            box-shadow: 0 8px 32px rgba(255, 215, 0, 0.3);
        }

        .badge-modal-icon.locked {
            background: var(--gray-700);
            filter: grayscale(1);
            opacity: 0.5;
        }

        .badge-modal-title {
            font-size: 20px;
            font-weight: 800;
            margin-bottom: 8px;
        }

        .badge-modal-desc {
            color: var(--gray-300);
            font-size: 14px;
            line-height: 1.5;
            margin-bottom: 16px;
        }

        .badge-modal-date {
            font-size: 12px;
            color: var(--green);
        }

        .badge-modal-progress {
            background: var(--gray-700);
            border-radius: 8px;
            height: 8px;
            overflow: hidden;
            margin-bottom: 8px;
        }

        .badge-modal-progress-fill {
            height: 100%;
            background: var(--red);
            border-radius: 8px;
        }

        .badge-modal-progress-text {
            font-size: 12px;
            color: var(--gray-300);
        }

        .badge-modal-close {
            margin-top: 20px;
            padding: 12px 32px;
            background: var(--gray-700);
            border: none;
            border-radius: 12px;
            color: var(--white);
            font-weight: 600;
            cursor: pointer;
        }

        /* CONTENT */
        .content {
            padding: 0 16px;
        }

        .section {
            margin-bottom: 24px;
        }

        .section-title {
            font-size: 12px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--gray-300);
            margin-bottom: 12px;
            padding-left: 4px;
        }

        /* MENU CARDS */
        .menu-card {
            background: var(--gray-800);
            border-radius: 16px;
            overflow: hidden;
        }

        .menu-item {
            display: flex;
            align-items: center;
            gap: 14px;
            padding: 16px;
            border-bottom: 1px solid var(--gray-600);
            cursor: pointer;
            transition: background 0.2s;
            text-decoration: none;
            color: inherit;
        }

        .menu-item:last-child {
            border-bottom: none;
        }

        .menu-item:active {
            background: var(--gray-700);
        }

        .menu-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
        }

        .menu-icon.red { background: rgba(230, 57, 70, 0.2); color: var(--red); }
        .menu-icon.green { background: rgba(0, 210, 106, 0.2); color: var(--green); }
        .menu-icon.blue { background: rgba(0, 122, 255, 0.2); color: var(--blue); }
        .menu-icon.orange { background: rgba(255, 149, 0, 0.2); color: var(--orange); }
        .menu-icon.gray { background: var(--gray-600); color: var(--white); }

        .menu-info {
            flex: 1;
        }

        .menu-info h4 {
            font-size: 15px;
            font-weight: 600;
            margin-bottom: 2px;
        }

        .menu-info p {
            font-size: 12px;
            color: var(--gray-300);
        }

        .menu-right {
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--gray-400);
        }

        .menu-badge {
            font-size: 11px;
            font-weight: 600;
            padding: 4px 10px;
            border-radius: 12px;
        }

        .menu-badge.connected {
            background: rgba(0, 210, 106, 0.2);
            color: var(--green);
        }

        .menu-badge.disconnected {
            background: var(--gray-600);
            color: var(--gray-300);
        }

        /* PHYSICAL DATA */
        .data-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }

        .data-card {
            background: var(--gray-800);
            border-radius: 12px;
            padding: 16px;
        }

        .data-card.full {
            grid-column: span 2;
        }

        .data-label {
            font-size: 11px;
            color: var(--gray-300);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 6px;
        }

        .data-value {
            font-size: 20px;
            font-weight: 700;
        }

        .data-unit {
            font-size: 14px;
            color: var(--gray-300);
            font-weight: 400;
        }

        /* BIOMETRICS */
        .biometrics-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }

        .biometric-card {
            background: var(--gray-800);
            border-radius: 12px;
            padding: 16px;
        }

        .biometric-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 12px;
        }

        .biometric-icon {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
        }

        .biometric-icon.heart { background: rgba(230, 57, 70, 0.2); color: var(--red); }
        .biometric-icon.steps { background: rgba(0, 210, 106, 0.2); color: var(--green); }
        .biometric-icon.sleep { background: rgba(0, 122, 255, 0.2); color: var(--blue); }
        .biometric-icon.calories { background: rgba(255, 149, 0, 0.2); color: var(--orange); }

        .biometric-title {
            font-size: 12px;
            color: var(--gray-300);
        }

        .biometric-value {
            font-size: 28px;
            font-weight: 800;
        }

        .biometric-unit {
            font-size: 12px;
            color: var(--gray-300);
        }

        .biometric-chart {
            height: 40px;
            margin-top: 12px;
            display: flex;
            align-items: flex-end;
            gap: 4px;
        }

        .biometric-bar {
            flex: 1;
            background: var(--gray-600);
            border-radius: 2px;
            min-height: 4px;
        }

        .biometric-bar.active {
            background: var(--red);
        }

        /* WEARABLE CONNECTION */
        .wearable-connect-card {
            background: linear-gradient(135deg, var(--gray-800), var(--gray-700));
            border: 1px solid var(--gray-600);
            border-radius: 16px;
            padding: 24px;
            text-align: center;
        }

        .wearable-icons {
            display: flex;
            justify-content: center;
            gap: 16px;
            margin-bottom: 16px;
        }

        .wearable-icon {
            width: 56px;
            height: 56px;
            background: var(--gray-600);
            border-radius: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }

        .wearable-icon.apple { color: var(--white); }
        .wearable-icon.google { color: #4285F4; }
        .wearable-icon.garmin { color: #007DC5; }
        .wearable-icon.fitbit { color: #00B0B9; }

        .wearable-title {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .wearable-text {
            font-size: 14px;
            color: var(--gray-300);
            margin-bottom: 20px;
        }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 14px 28px;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 700;
            border: none;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary {
            background: var(--red);
            color: var(--white);
        }

        .btn-primary:hover {
            transform: scale(1.02);
        }

        .btn-secondary {
            background: var(--gray-600);
            color: var(--white);
        }

        /* FAQ */
        .faq-item {
            background: var(--gray-800);
            border-radius: 12px;
            margin-bottom: 8px;
            overflow: hidden;
        }

        .faq-question {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
        }

        .faq-question i {
            transition: transform 0.3s;
            color: var(--gray-300);
        }

        .faq-item.open .faq-question i {
            transform: rotate(180deg);
        }

        .faq-answer {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s;
        }

        .faq-item.open .faq-answer {
            max-height: 200px;
        }

        .faq-answer-content {
            padding: 0 16px 16px;
            font-size: 13px;
            color: var(--gray-300);
            line-height: 1.6;
        }

        /* LOGOUT */
        .logout-btn {
            width: 100%;
            padding: 16px;
            background: transparent;
            border: 1px solid var(--red);
            color: var(--red);
            border-radius: 12px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 8px;
            transition: all 0.2s;
        }

        .logout-btn:hover {
            background: var(--red);
            color: var(--white);
        }

        .app-version {
            text-align: center;
            color: var(--gray-400);
            font-size: 12px;
            margin-top: 24px;
            padding-bottom: 20px;
        }

        /* BOTTOM NAV */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--gray-900);
            border-top: 1px solid var(--gray-600);
            display: flex;
            justify-content: space-around;
            padding: 10px 0 20px;
            z-index: 100;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            color: var(--gray-400);
            text-decoration: none;
            font-size: 10px;
            padding: 4px 12px;
        }

        .nav-item i {
            font-size: 20px;
        }

        .nav-item.active {
            color: var(--red);
        }

        /* MODAL */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.8);
            z-index: 200;
            display: none;
            align-items: flex-end;
            justify-content: center;
        }

        .modal-overlay.show {
            display: flex;
        }

        .modal {
            background: var(--gray-800);
            width: 100%;
            max-width: 500px;
            border-radius: 24px 24px 0 0;
            padding: 24px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        .modal-title {
            font-size: 20px;
            font-weight: 800;
        }

        .modal-close {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: var(--gray-600);
            border: none;
            color: var(--white);
            font-size: 18px;
            cursor: pointer;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            font-size: 12px;
            font-weight: 600;
            color: var(--gray-300);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }

        .form-input {
            width: 100%;
            padding: 14px 16px;
            background: var(--gray-700);
            border: 1px solid var(--gray-600);
            border-radius: 10px;
            color: var(--white);
            font-size: 15px;
            font-family: inherit;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--red);
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        /* LOADING */
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid var(--gray-600);
            border-top-color: var(--red);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <!-- HEADER -->
    <header class="header">
        <div></div>
        <div class="header-title">Profilo</div>
        <button class="header-btn" onclick="openEditModal()"><i class="fas fa-pen"></i></button>
    </header>

    <!-- PROFILE HERO -->
    <section class="profile-hero" id="profileHero">
        <div class="profile-hero-bg" id="heroBg"></div>
        <div class="profile-hero-overlay"></div>
        <div class="profile-hero-content">
            <div class="avatar-container">
                <div class="avatar" id="avatar">--</div>
                <label class="avatar-edit" title="Cambia foto">
                    <i class="fas fa-camera"></i>
                    <input type="file" accept="image/*" id="photoInput" onchange="uploadPhoto(this)">
                </label>
            </div>
            <h1 class="profile-name" id="profileName">-</h1>
            <p class="profile-meta" id="profileMeta">-</p>
            <div class="level-badge">
                <div class="level-icon"><i class="fas fa-bolt"></i></div>
                <div class="level-info">
                    <div class="level-title">Livello <span id="userLevel">1</span></div>
                    <div class="level-xp"><span id="userXP">0</span> XP totali</div>
                </div>
            </div>
        </div>
    </section>

    <!-- STATS -->
    <div class="stats-grid">
        <div class="stat-item">
            <div class="stat-value green" id="statWorkouts">0</div>
            <div class="stat-label">Workout</div>
        </div>
        <div class="stat-item">
            <div class="stat-value red" id="statStreak">0</div>
            <div class="stat-label">Streak</div>
        </div>
        <div class="stat-item">
            <div class="stat-value blue" id="statWeeks">0</div>
            <div class="stat-label">Settimane</div>
        </div>
        <div class="stat-item">
            <div class="stat-value orange" id="statTests">0</div>
            <div class="stat-label">Test</div>
        </div>
    </div>

    <!-- BADGES SECTION -->
    <section class="badges-section" id="badges">
        <div class="badges-header">
            <div class="badges-title">üèÜ I Miei Badge</div>
            <div class="badges-count"><span id="badgesUnlocked">0</span>/8 sbloccati</div>
        </div>
        <div class="badges-grid" id="badgesGrid">
            <!-- Loaded by JS -->
        </div>
    </section>

    <!-- BADGE MODAL -->
    <div class="badge-modal" id="badgeModal" onclick="closeBadgeModal(event)">
        <div class="badge-modal-content" onclick="event.stopPropagation()">
            <div class="badge-modal-icon" id="badgeModalIcon">üî•</div>
            <div class="badge-modal-title" id="badgeModalTitle">-</div>
            <div class="badge-modal-desc" id="badgeModalDesc">-</div>
            <div id="badgeModalStatus"></div>
            <button class="badge-modal-close" onclick="closeBadgeModal()">Chiudi</button>
        </div>
    </div>

    <div class="content">
        <!-- WEARABLES / BIOMETRICS -->
        <section class="section" id="wearablesSection">
            <div class="section-title">Monitoraggio Salute</div>
            <div id="wearablesContent">
                <!-- Loaded by JS -->
            </div>
        </section>

        <!-- DATI FISICI -->
        <section class="section">
            <div class="section-title">Dati Fisici</div>
            <div class="data-grid">
                <div class="data-card">
                    <div class="data-label">Altezza</div>
                    <div class="data-value" id="dataHeight">-</div>
                </div>
                <div class="data-card">
                    <div class="data-label">Peso</div>
                    <div class="data-value" id="dataWeight">-</div>
                </div>
                <div class="data-card">
                    <div class="data-label">Et√†</div>
                    <div class="data-value" id="dataAge">-</div>
                </div>
                <div class="data-card">
                    <div class="data-label">BMI</div>
                    <div class="data-value" id="dataBMI">-</div>
                </div>
            </div>
        </section>

        <!-- PROGRESSI -->
        <section class="section">
            <div class="section-title">I Miei Progressi</div>
            <div class="menu-card">
                <a href="app-progress.html" class="menu-item">
                    <div class="menu-icon red"><i class="fas fa-chart-line"></i></div>
                    <div class="menu-info">
                        <h4>Statistiche Allenamenti</h4>
                        <p>Grafici e andamento</p>
                    </div>
                    <div class="menu-right"><i class="fas fa-chevron-right"></i></div>
                </a>
                <a href="app-progress.html#tests" class="menu-item">
                    <div class="menu-icon green"><i class="fas fa-stopwatch"></i></div>
                    <div class="menu-info">
                        <h4>Test Fisici</h4>
                        <p>Miglioramenti nel tempo</p>
                    </div>
                    <div class="menu-right"><i class="fas fa-chevron-right"></i></div>
                </a>
            </div>
        </section>

        <!-- ACCOUNT -->
        <section class="section">
            <div class="section-title">Account</div>
            <div class="menu-card">
                <div class="menu-item" onclick="openEditModal()">
                    <div class="menu-icon blue"><i class="fas fa-user-edit"></i></div>
                    <div class="menu-info">
                        <h4>Modifica Profilo</h4>
                        <p>Nome, dati personali</p>
                    </div>
                    <div class="menu-right"><i class="fas fa-chevron-right"></i></div>
                </div>
                <a href="anamnesi.html" class="menu-item">
                    <div class="menu-icon orange"><i class="fas fa-clipboard-list"></i></div>
                    <div class="menu-info">
                        <h4>Anamnesi</h4>
                        <p>Obiettivi, disponibilit√†, infortuni</p>
                    </div>
                    <div class="menu-right"><i class="fas fa-chevron-right"></i></div>
                </a>
                <div class="menu-item" onclick="toggleNotifications()">
                    <div class="menu-icon gray"><i class="fas fa-bell"></i></div>
                    <div class="menu-info">
                        <h4>Notifiche</h4>
                        <p>Reminder allenamenti</p>
                    </div>
                    <div class="menu-right">
                        <span class="menu-badge" id="notifBadge">Attive</span>
                    </div>
                </div>
            </div>
        </section>

        <!-- FAQ -->
        <section class="section">
            <div class="section-title">Domande Frequenti</div>
            <div id="faqList">
                <div class="faq-item">
                    <div class="faq-question" onclick="toggleFaq(this)">
                        <span>Come funziona il sistema XP?</span>
                        <i class="fas fa-chevron-down"></i>
                    </div>
                    <div class="faq-answer">
                        <div class="faq-answer-content">
                            Guadagni XP completando workout, raggiungendo streak e superando test fisici. Ogni 1000 XP sali di livello. I livelli sbloccano badge e mostrano i tuoi progressi al coach.
                        </div>
                    </div>
                </div>
                <div class="faq-item">
                    <div class="faq-question" onclick="toggleFaq(this)">
                        <span>Come collego il mio Apple Watch?</span>
                        <i class="fas fa-chevron-down"></i>
                    </div>
                    <div class="faq-answer">
                        <div class="faq-answer-content">
                            Clicca su "Connetti Dispositivo" nella sezione Monitoraggio Salute. L'app chieder√† il permesso di accedere ai dati di Apple Health. Una volta autorizzato, i dati si sincronizzeranno automaticamente.
                        </div>
                    </div>
                </div>
                <div class="faq-item">
                    <div class="faq-question" onclick="toggleFaq(this)">
                        <span>Come contatto il mio coach?</span>
                        <i class="fas fa-chevron-down"></i>
                    </div>
                    <div class="faq-answer">
                        <div class="faq-answer-content">
                            Vai nella sezione Chat dal menu in basso. Puoi inviare messaggi di testo, foto e vocali. Il coach risponder√† appena possibile.
                        </div>
                    </div>
                </div>
                <div class="faq-item">
                    <div class="faq-question" onclick="toggleFaq(this)">
                        <span>Cosa sono i test fisici?</span>
                        <i class="fas fa-chevron-down"></i>
                    </div>
                    <div class="faq-answer">
                        <div class="faq-answer-content">
                            Ogni 4 settimane circa il coach ti assegner√† dei test fisici (sprint, forza, resistenza, etc.) per misurare i tuoi progressi. I risultati vengono salvati e mostrati in grafici nella sezione Progressi.
                        </div>
                    </div>
                </div>
                <div class="faq-item">
                    <div class="faq-question" onclick="toggleFaq(this)">
                        <span>Come vengono creati i miei workout?</span>
                        <i class="fas fa-chevron-down"></i>
                    </div>
                    <div class="faq-answer">
                        <div class="faq-answer-content">
                            Il tuo coach usa un sistema AI avanzato che analizza il tuo sport, ruolo, obiettivi, livello e dati biometrici per creare workout personalizzati. Ogni programma √® unico per te.
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- SUPPORT -->
        <section class="section">
            <div class="section-title">Supporto</div>
            <div class="menu-card">
                <a href="app-chat.html" class="menu-item">
                    <div class="menu-icon red"><i class="fas fa-comments"></i></div>
                    <div class="menu-info">
                        <h4>Chat con il Coach</h4>
                        <p>Parla direttamente con Gabriele</p>
                    </div>
                    <div class="menu-right"><i class="fas fa-chevron-right"></i></div>
                </a>
                <a href="mailto:help@grperform.it" class="menu-item">
                    <div class="menu-icon gray"><i class="fas fa-envelope"></i></div>
                    <div class="menu-info">
                        <h4>Contatta Supporto</h4>
                        <p>help@grperform.it</p>
                    </div>
                    <div class="menu-right"><i class="fas fa-chevron-right"></i></div>
                </a>
            </div>
        </section>

        <button class="logout-btn" onclick="logout()">
            <i class="fas fa-sign-out-alt"></i> Esci
        </button>

        <p class="app-version">GR Perform v1.2.0</p>
    </div>

    <!-- BOTTOM NAV -->
    <nav class="bottom-nav">
        <a href="app-dashboard.html" class="nav-item">
            <i class="fas fa-home"></i>
            <span>Home</span>
        </a>
        <a href="app-workouts.html" class="nav-item">
            <i class="fas fa-dumbbell"></i>
            <span>Workout</span>
        </a>
        <a href="app-progress.html" class="nav-item">
            <i class="fas fa-chart-line"></i>
            <span>Progressi</span>
        </a>
        <a href="app-chat.html" class="nav-item">
            <i class="fas fa-comment"></i>
            <span>Chat</span>
        </a>
        <a href="app-profile.html" class="nav-item active">
            <i class="fas fa-user"></i>
            <span>Profilo</span>
        </a>
    </nav>

    <!-- EDIT PROFILE MODAL -->
    <div class="modal-overlay" id="editModal">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title">Modifica Profilo</h2>
                <button class="modal-close" onclick="closeEditModal()"><i class="fas fa-times"></i></button>
            </div>
            <form id="editForm" onsubmit="saveProfile(event)">
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Nome</label>
                        <input type="text" class="form-input" id="editFirstName" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Cognome</label>
                        <input type="text" class="form-input" id="editLastName" required>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Data di Nascita</label>
                    <input type="date" class="form-input" id="editBirthDate">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Altezza (cm)</label>
                        <input type="number" class="form-input" id="editHeight" min="100" max="250">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Peso (kg)</label>
                        <input type="number" class="form-input" id="editWeight" min="30" max="200" step="0.1">
                    </div>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%; margin-top: 8px;">
                    Salva Modifiche
                </button>
            </form>
        </div>
    </div>

    <script src="js/supabase-client.js"></script>
    <script>
        const athleteId = localStorage.getItem('gr_athlete_id');
        let athlete = null;
        let healthData = null;

        if (!athleteId) {
            window.location.href = 'login.html';
        }

        document.addEventListener('DOMContentLoaded', () => {
            loadProfile();
        });

        async function loadProfile() {
            try {
                const athletes = await supabase.fetch('athletes', `?id=eq.${athleteId}`);
                athlete = athletes[0];

                if (!athlete) {
                    window.location.href = 'login.html';
                    return;
                }

                // Set sport-specific background
                const sport = (athlete.sport || '').toLowerCase().replace(/\s/g, '');
                const heroBg = document.getElementById('heroBg');
                heroBg.className = 'profile-hero-bg';
                if (['calcio', 'football', 'soccer'].includes(sport)) {
                    heroBg.classList.add('calcio');
                } else if (['basket', 'basketball', 'pallacanestro'].includes(sport)) {
                    heroBg.classList.add('basket');
                } else if (['boxe', 'boxing', 'pugilato'].includes(sport)) {
                    heroBg.classList.add('boxe');
                } else if (['palestra', 'fitness', 'gym', 'bodybuilding'].includes(sport)) {
                    heroBg.classList.add('palestra');
                } else if (['running', 'corsa', 'atletica'].includes(sport)) {
                    heroBg.classList.add('running');
                } else {
                    heroBg.classList.add('default');
                }

                // Show background with fade-in after correct class is set
                setTimeout(() => heroBg.classList.add('loaded'), 50);

                // Avatar - check Supabase first, then localStorage as fallback
                const initials = (athlete.first_name?.[0] || '') + (athlete.last_name?.[0] || '');
                const avatarEl = document.getElementById('avatar');
                const savedPhoto = athlete.profile_photo || localStorage.getItem('gr_athlete_photo');
                
                if (savedPhoto) {
                    avatarEl.innerHTML = `<img src="${savedPhoto}" alt="Profile">`;
                    localStorage.setItem('gr_athlete_photo', savedPhoto);
                } else {
                    avatarEl.textContent = initials.toUpperCase();
                }

                // Name & Meta
                document.getElementById('profileName').textContent = 
                    `${athlete.first_name} ${athlete.last_name}`;
                
                const meta = [athlete.sport, athlete.role, athlete.goal].filter(Boolean).join(' ‚Ä¢ ');
                document.getElementById('profileMeta').textContent = meta || athlete.experience_level || '-';

                // Level & XP
                document.getElementById('userLevel').textContent = athlete.current_level || 1;
                document.getElementById('userXP').textContent = athlete.total_xp || 0;

                // Physical Data
                document.getElementById('dataHeight').innerHTML = athlete.height_cm 
                    ? `${athlete.height_cm} <span class="data-unit">cm</span>` : '-';
                document.getElementById('dataWeight').innerHTML = athlete.weight_kg 
                    ? `${athlete.weight_kg} <span class="data-unit">kg</span>` : '-';

                // Age
                if (athlete.birth_date) {
                    const birth = new Date(athlete.birth_date);
                    const today = new Date();
                    let age = today.getFullYear() - birth.getFullYear();
                    const m = today.getMonth() - birth.getMonth();
                    if (m < 0 || (m === 0 && today.getDate() < birth.getDate())) age--;
                    document.getElementById('dataAge').innerHTML = `${age} <span class="data-unit">anni</span>`;
                }

                // BMI
                if (athlete.height_cm && athlete.weight_kg) {
                    const heightM = athlete.height_cm / 100;
                    const bmi = (athlete.weight_kg / (heightM * heightM)).toFixed(1);
                    document.getElementById('dataBMI').textContent = bmi;
                }

                // Load stats
                await loadStats();

                // Fill edit form
                document.getElementById('editFirstName').value = athlete.first_name || '';
                document.getElementById('editLastName').value = athlete.last_name || '';
                document.getElementById('editBirthDate').value = athlete.birth_date || '';
                document.getElementById('editHeight').value = athlete.height_cm || '';
                document.getElementById('editWeight').value = athlete.weight_kg || '';

                // Now check wearables AFTER athlete is loaded
                checkHealthKit();

                // Load badges
                await loadBadges();

            } catch (error) {
                console.error('Error loading profile:', error);
            }
        }

        // ===== BADGES SYSTEM =====
        
        const BADGES = [
            { id: 'first_workout', name: 'Prima Fiamma', icon: 'üî•', desc: 'Completa il tuo primo workout', requirement: { type: 'workouts', count: 1 } },
            { id: 'streak_7', name: 'Costanza', icon: 'üí™', desc: 'Mantieni una streak di 7 giorni', requirement: { type: 'streak', count: 7 } },
            { id: 'workouts_10', name: 'Maratoneta', icon: 'üèÉ', desc: 'Completa 10 workout', requirement: { type: 'workouts', count: 10 } },
            { id: 'workouts_25', name: 'Instancabile', icon: '‚ö°', desc: 'Completa 25 workout', requirement: { type: 'workouts', count: 25 } },
            { id: 'workouts_50', name: 'Leggenda', icon: 'üëë', desc: 'Completa 50 workout', requirement: { type: 'workouts', count: 50 } },
            { id: 'test_improved', name: 'In Crescita', icon: 'üìà', desc: 'Migliora un test fisico', requirement: { type: 'tests', count: 1 } },
            { id: 'level_5', name: 'Atleta', icon: 'üéØ', desc: 'Raggiungi il livello 5', requirement: { type: 'level', count: 5 } },
            { id: 'level_10', name: 'Elite', icon: 'üèÜ', desc: 'Raggiungi il livello 10', requirement: { type: 'level', count: 10 } }
        ];

        let athleteStats = { workouts: 0, streak: 0, tests: 0, level: 1 };

        async function loadBadges() {
            // Get stats for badge calculation
            try {
                const workouts = await supabase.fetch('workouts', 
                    `?athlete_id=eq.${athleteId}&status=eq.completed&select=id`
                );
                athleteStats.workouts = workouts?.length || 0;
                athleteStats.streak = Math.min(athleteStats.workouts, 7); // Simplified streak
                athleteStats.level = athlete.current_level || 1;
                
                // Check for test improvements
                try {
                    const tests = await supabase.fetch('fitness_tests', 
                        `?athlete_id=eq.${athleteId}&select=test_name`
                    );
                    athleteStats.tests = tests?.length || 0;
                } catch (e) {
                    athleteStats.tests = 0;
                }
            } catch (e) {
                console.error('Error loading badge stats:', e);
            }

            renderBadges();
        }

        function checkBadgeUnlocked(badge) {
            const req = badge.requirement;
            switch (req.type) {
                case 'workouts':
                    return athleteStats.workouts >= req.count;
                case 'streak':
                    return athleteStats.streak >= req.count;
                case 'tests':
                    return athleteStats.tests >= req.count;
                case 'level':
                    return athleteStats.level >= req.count;
                default:
                    return false;
            }
        }

        function getBadgeProgress(badge) {
            const req = badge.requirement;
            let current = 0;
            switch (req.type) {
                case 'workouts':
                    current = athleteStats.workouts;
                    break;
                case 'streak':
                    current = athleteStats.streak;
                    break;
                case 'tests':
                    current = athleteStats.tests;
                    break;
                case 'level':
                    current = athleteStats.level;
                    break;
            }
            return { current, target: req.count, percent: Math.min(100, (current / req.count) * 100) };
        }

        function renderBadges() {
            const grid = document.getElementById('badgesGrid');
            let unlockedCount = 0;

            grid.innerHTML = BADGES.map(badge => {
                const unlocked = checkBadgeUnlocked(badge);
                if (unlocked) unlockedCount++;
                
                return `
                    <div class="badge-item ${unlocked ? 'unlocked' : 'locked'}" onclick="showBadgeModal('${badge.id}')">
                        <div class="badge-icon">${badge.icon}</div>
                        <div class="badge-name">${badge.name}</div>
                    </div>
                `;
            }).join('');

            document.getElementById('badgesUnlocked').textContent = unlockedCount;
        }

        function showBadgeModal(badgeId) {
            const badge = BADGES.find(b => b.id === badgeId);
            if (!badge) return;

            const unlocked = checkBadgeUnlocked(badge);
            const progress = getBadgeProgress(badge);

            document.getElementById('badgeModalIcon').textContent = badge.icon;
            document.getElementById('badgeModalIcon').className = `badge-modal-icon ${unlocked ? '' : 'locked'}`;
            document.getElementById('badgeModalTitle').textContent = badge.name;
            document.getElementById('badgeModalDesc').textContent = badge.desc;

            const statusEl = document.getElementById('badgeModalStatus');
            if (unlocked) {
                statusEl.innerHTML = '<div class="badge-modal-date">‚úÖ Sbloccato!</div>';
            } else {
                statusEl.innerHTML = `
                    <div class="badge-modal-progress">
                        <div class="badge-modal-progress-fill" style="width: ${progress.percent}%"></div>
                    </div>
                    <div class="badge-modal-progress-text">${progress.current}/${progress.target}</div>
                `;
            }

            document.getElementById('badgeModal').classList.add('visible');
        }

        function closeBadgeModal(event) {
            if (event && event.target !== event.currentTarget) return;
            document.getElementById('badgeModal').classList.remove('visible');
        }

        async function loadStats() {
            try {
                // Completed workouts
                const workouts = await supabase.fetch('workouts', 
                    `?athlete_id=eq.${athleteId}&status=eq.completed&select=id`
                );
                document.getElementById('statWorkouts').textContent = workouts.length;

                // Weeks trained
                const programs = await supabase.fetch('programs', 
                    `?athlete_id=eq.${athleteId}&select=current_week`
                );
                const totalWeeks = programs.reduce((sum, p) => sum + (p.current_week || 0), 0);
                document.getElementById('statWeeks').textContent = totalWeeks;

                // Streak
                document.getElementById('statStreak').textContent = Math.min(workouts.length, 7);

                // Tests count
                try {
                    const tests = await supabase.fetch('fitness_tests', 
                        `?athlete_id=eq.${athleteId}&select=id`
                    );
                    document.getElementById('statTests').textContent = tests.length;
                } catch (e) {
                    document.getElementById('statTests').textContent = '0';
                }

            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }

        // ===== HEALTH KIT / WEARABLES =====
        
        function checkHealthKit() {
            // Check if HealthKit is available (iOS Safari)
            const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
            const hasHealthData = athlete?.biometrics_data?.hasData;

            if (hasHealthData) {
                renderConnectedWearables();
            } else {
                renderWearableConnect(isIOS);
            }
        }

        function renderWearableConnect(isIOS) {
            const html = `
                <div class="wearable-connect-card">
                    <div class="wearable-icons">
                        <div class="wearable-icon apple"><i class="fab fa-apple"></i></div>
                        <div class="wearable-icon google"><i class="fab fa-google"></i></div>
                        <div class="wearable-icon garmin"><i class="fas fa-circle"></i></div>
                    </div>
                    <h3 class="wearable-title">Connetti il tuo dispositivo</h3>
                    <p class="wearable-text">
                        Sincronizzando Apple Watch, Google Fit, Garmin o Fitbit permetti al tuo coach di monitorare frequenza cardiaca, qualit√† del sonno e livelli di energia per creare allenamenti ancora pi√π personalizzati.
                    </p>
                    <button class="btn btn-primary" onclick="connectHealthKit()">
                        <i class="fas fa-link"></i> Connetti Dispositivo
                    </button>
                </div>
            `;
            document.getElementById('wearablesContent').innerHTML = html;
        }

        function renderConnectedWearables() {
            const data = athlete?.biometrics_data || {};
            const html = `
                <div class="menu-card" style="margin-bottom: 16px;">
                    <div class="menu-item">
                        <div class="menu-icon green"><i class="fab fa-apple"></i></div>
                        <div class="menu-info">
                            <h4>${data.source || 'Apple Health'}</h4>
                            <p>Ultimo sync: ${data.lastSync || 'adesso'}</p>
                        </div>
                        <span class="menu-badge connected">Connesso</span>
                    </div>
                </div>
                <div class="biometrics-grid">
                    <div class="biometric-card">
                        <div class="biometric-header">
                            <div class="biometric-icon heart"><i class="fas fa-heart"></i></div>
                            <div class="biometric-title">Frequenza Cardiaca</div>
                        </div>
                        <div class="biometric-value">${data.heartRate || '--'}</div>
                        <div class="biometric-unit">bpm media</div>
                    </div>
                    <div class="biometric-card">
                        <div class="biometric-header">
                            <div class="biometric-icon steps"><i class="fas fa-shoe-prints"></i></div>
                            <div class="biometric-title">Passi Oggi</div>
                        </div>
                        <div class="biometric-value">${data.steps?.toLocaleString() || '--'}</div>
                        <div class="biometric-unit">passi</div>
                    </div>
                    <div class="biometric-card">
                        <div class="biometric-header">
                            <div class="biometric-icon calories"><i class="fas fa-fire"></i></div>
                            <div class="biometric-title">Calorie</div>
                        </div>
                        <div class="biometric-value">${data.calories || '--'}</div>
                        <div class="biometric-unit">kcal bruciate</div>
                    </div>
                    <div class="biometric-card">
                        <div class="biometric-header">
                            <div class="biometric-icon sleep"><i class="fas fa-moon"></i></div>
                            <div class="biometric-title">Sonno</div>
                        </div>
                        <div class="biometric-value">${data.sleep || '--'}</div>
                        <div class="biometric-unit">ore stanotte</div>
                    </div>
                </div>
                <button class="btn btn-secondary" style="width: 100%; margin-top: 16px;" onclick="syncHealthData()">
                    <i class="fas fa-sync"></i> Sincronizza Ora
                </button>
            `;
            document.getElementById('wearablesContent').innerHTML = html;
        }

        async function connectHealthKit() {
            // Check if we're in a PWA or can access Health APIs
            const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
            
            if (isIOS) {
                // For iOS, we'll use a native bridge or simulate
                // In production, this would use Apple HealthKit via Capacitor/Cordova
                
                // Simulate permission request
                const proceed = confirm(
                    'GR Perform vuole accedere ai tuoi dati di Salute.\n\n' +
                    'Verranno letti:\n' +
                    '‚Ä¢ Frequenza cardiaca\n' +
                    '‚Ä¢ Passi\n' +
                    '‚Ä¢ Calorie bruciate\n' +
                    '‚Ä¢ Dati sonno\n\n' +
                    'Vuoi continuare?'
                );

                if (proceed) {
                    await simulateHealthKitConnect();
                }
            } else {
                // For Android/Web, use Google Fit API or simulate
                const proceed = confirm(
                    'GR Perform vuole accedere a Google Fit.\n\n' +
                    'Verranno letti i dati di attivit√† e salute.\n\n' +
                    'Vuoi continuare?'
                );

                if (proceed) {
                    await simulateGoogleFitConnect();
                }
            }
        }

        async function simulateHealthKitConnect() {
            // Show loading
            document.getElementById('wearablesContent').innerHTML = `
                <div class="wearable-connect-card">
                    <div class="loading-spinner"></div>
                    <p style="margin-top: 16px; color: var(--gray-300);">Connessione in corso...</p>
                </div>
            `;

            // Simulate API call delay
            await new Promise(r => setTimeout(r, 2000));

            // Save mock health data
            const healthData = {
                hasData: true,
                source: 'Apple Health',
                lastSync: new Date().toLocaleTimeString('it-IT', { hour: '2-digit', minute: '2-digit' }),
                heartRate: Math.floor(60 + Math.random() * 20),
                steps: Math.floor(5000 + Math.random() * 8000),
                calories: Math.floor(300 + Math.random() * 500),
                sleep: (6 + Math.random() * 2).toFixed(1)
            };

            await supabase.update('athletes', athleteId, {
                biometrics_data: healthData
            });

            athlete.biometrics_data = healthData;
            renderConnectedWearables();

            alert('Apple Health connesso con successo!');
        }

        async function simulateGoogleFitConnect() {
            document.getElementById('wearablesContent').innerHTML = `
                <div class="wearable-connect-card">
                    <div class="loading-spinner"></div>
                    <p style="margin-top: 16px; color: var(--gray-300);">Connessione in corso...</p>
                </div>
            `;

            await new Promise(r => setTimeout(r, 2000));

            const healthData = {
                hasData: true,
                source: 'Google Fit',
                lastSync: new Date().toLocaleTimeString('it-IT', { hour: '2-digit', minute: '2-digit' }),
                heartRate: Math.floor(60 + Math.random() * 20),
                steps: Math.floor(5000 + Math.random() * 8000),
                calories: Math.floor(300 + Math.random() * 500),
                sleep: (6 + Math.random() * 2).toFixed(1)
            };

            await supabase.update('athletes', athleteId, {
                biometrics_data: healthData
            });

            athlete.biometrics_data = healthData;
            renderConnectedWearables();

            alert('Google Fit connesso con successo!');
        }

        async function syncHealthData() {
            const btn = event.target;
            btn.innerHTML = '<div class="loading-spinner"></div>';
            btn.disabled = true;

            await new Promise(r => setTimeout(r, 1500));

            // Update with new mock data
            const healthData = {
                ...athlete.biometrics_data,
                lastSync: new Date().toLocaleTimeString('it-IT', { hour: '2-digit', minute: '2-digit' }),
                heartRate: Math.floor(60 + Math.random() * 20),
                steps: Math.floor(5000 + Math.random() * 8000),
                calories: Math.floor(300 + Math.random() * 500),
                sleep: (6 + Math.random() * 2).toFixed(1)
            };

            await supabase.update('athletes', athleteId, {
                biometrics_data: healthData
            });

            athlete.biometrics_data = healthData;
            renderConnectedWearables();
        }

        // ===== PHOTO UPLOAD =====
        
        async function uploadPhoto(input) {
            const file = input.files[0];
            if (!file) return;

            const avatar = document.getElementById('avatar');
            const originalContent = avatar.innerHTML;
            avatar.innerHTML = '<div class="loading-spinner"></div>';

            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const base64 = e.target.result;

                    // Resize image before saving (higher quality)
                    const resized = await resizeImage(base64, 400);

                    // Save to Supabase
                    const result = await supabase.update('athletes', athleteId, {
                        profile_photo: resized
                    });

                    console.log('Photo save result:', result);
                    
                    // Check if save was successful
                    if (result && result.error) {
                        console.error('Supabase error:', result.error);
                        // Still save to localStorage as fallback
                    }

                    // Update local athlete object
                    athlete.profile_photo = resized;

                    // Update avatar
                    avatar.innerHTML = `<img src="${resized}" alt="Profile">`;
                    
                    // ALWAYS store in localStorage (primary storage for now)
                    localStorage.setItem('gr_athlete_photo', resized);
                    
                    console.log('Photo saved successfully, length:', resized.length);

                } catch (error) {
                    console.error('Upload error:', error);
                    avatar.innerHTML = originalContent;
                    alert('Errore durante il caricamento. Riprova.');
                }
            };

            reader.onerror = () => {
                console.error('File read error');
                avatar.innerHTML = originalContent;
                alert('Errore nella lettura del file.');
            };

            reader.readAsDataURL(file);
        }

        function resizeImage(base64, maxSize) {
            return new Promise((resolve) => {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    let width = img.width;
                    let height = img.height;

                    if (width > height) {
                        if (width > maxSize) {
                            height *= maxSize / width;
                            width = maxSize;
                        }
                    } else {
                        if (height > maxSize) {
                            width *= maxSize / height;
                            height = maxSize;
                        }
                    }

                    canvas.width = width;
                    canvas.height = height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);
                    resolve(canvas.toDataURL('image/jpeg', 0.92));
                };
                img.src = base64;
            });
        }

        // ===== EDIT PROFILE =====
        
        function openEditModal() {
            document.getElementById('editModal').classList.add('show');
        }

        function closeEditModal() {
            document.getElementById('editModal').classList.remove('show');
        }

        async function saveProfile(e) {
            e.preventDefault();

            const data = {
                first_name: document.getElementById('editFirstName').value,
                last_name: document.getElementById('editLastName').value,
                birth_date: document.getElementById('editBirthDate').value || null,
                height_cm: parseInt(document.getElementById('editHeight').value) || null,
                weight_kg: parseFloat(document.getElementById('editWeight').value) || null
            };

            try {
                await supabase.update('athletes', athleteId, data);
                
                // Update localStorage
                localStorage.setItem('gr_athlete_name', `${data.first_name} ${data.last_name}`);
                
                closeEditModal();
                loadProfile();
                
            } catch (error) {
                console.error('Error saving profile:', error);
                alert('Errore durante il salvataggio');
            }
        }

        // ===== FAQ =====
        
        function toggleFaq(el) {
            const item = el.closest('.faq-item');
            item.classList.toggle('open');
        }

        // ===== NOTIFICATIONS =====
        
        function toggleNotifications() {
            const badge = document.getElementById('notifBadge');
            if (badge.textContent === 'Attive') {
                badge.textContent = 'Disattive';
                badge.classList.remove('connected');
                badge.classList.add('disconnected');
            } else {
                badge.textContent = 'Attive';
                badge.classList.add('connected');
                badge.classList.remove('disconnected');
            }
        }

        // ===== LOGOUT =====
        
        function logout() {
            if (confirm('Sei sicuro di voler uscire?')) {
                localStorage.removeItem('gr_athlete_id');
                localStorage.removeItem('gr_athlete_name');
                localStorage.removeItem('gr_athlete_photo');
                localStorage.removeItem('gr_logged_in');
                window.location.replace('login.html');
            }
        }

        // Close modal on background click
        document.getElementById('editModal').addEventListener('click', (e) => {
            if (e.target.id === 'editModal') {
                closeEditModal();
            }
        });
    </script>
</body>
</html>
