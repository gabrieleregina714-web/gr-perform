<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GR Perform - AI Workout Lab</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        :root {
            --red: #E63946;
            --black: #000;
            --gray-900: #0A0A0A;
            --gray-800: #111;
            --gray-700: #1A1A1A;
            --gray-600: #222;
            --gray-500: #666;
            --gray-400: #888;
            --gray-300: #AAA;
            --white: #FFF;
            --green: #00D26A;
            --blue: #2196F3;
            --purple: #9C27B0;
            --orange: #FF9800;
            --cyan: #00BCD4;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--black);
            color: var(--white);
            min-height: 100vh;
        }

        /* SIDEBAR */
        .sidebar {
            position: fixed;
            left: 0; top: 0;
            width: 72px; height: 100vh;
            background: var(--gray-900);
            border-right: 1px solid var(--gray-700);
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px 0;
            z-index: 100;
        }

        .logo {
            width: 44px; height: 44px;
            background: linear-gradient(135deg, #E63946, #FF6B6B);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 900;
            margin-bottom: 40px;
            cursor: pointer;
            text-decoration: none;
            color: var(--white);
        }

        .nav-item {
            width: 44px; height: 44px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--gray-500);
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.2s;
            text-decoration: none;
            position: relative;
        }

        .nav-item:hover { background: var(--gray-700); color: var(--white); }
        .nav-item.active { background: var(--gray-700); color: var(--white); }
        .nav-item.active::before {
            content: '';
            position: absolute;
            left: 0;
            width: 3px;
            height: 24px;
            background: var(--red);
            border-radius: 0 2px 2px 0;
        }

        .nav-spacer { flex: 1; }

        /* MAIN */
        .main { margin-left: 72px; min-height: 100vh; }

        /* HERO HEADER */
        .hero-header {
            background: linear-gradient(135deg, var(--gray-900) 0%, var(--black) 100%);
            padding: 40px;
            border-bottom: 1px solid var(--gray-700);
            position: relative;
            overflow: hidden;
        }

        .hero-header::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -10%;
            width: 400px;
            height: 400px;
            background: radial-gradient(circle, rgba(230,57,70,0.1) 0%, transparent 70%);
            pointer-events: none;
        }

        .hero-content {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            position: relative;
            z-index: 1;
        }

        .hero-left h1 {
            font-size: 36px;
            font-weight: 900;
            letter-spacing: -1.5px;
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .hero-left h1 .gradient-text {
            background: linear-gradient(135deg, var(--red), var(--orange));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .hero-subtitle {
            color: var(--gray-400);
            font-size: 14px;
            margin-top: 8px;
            max-width: 400px;
        }

        /* ATHLETE SELECTOR */
        .athlete-selector {
            display: flex;
            align-items: center;
            gap: 16px;
            background: var(--gray-800);
            padding: 12px 20px 12px 12px;
            border-radius: 16px;
            border: 1px solid var(--gray-600);
        }

        .athlete-avatar-lg {
            width: 48px; height: 48px;
            border-radius: 12px;
            background: linear-gradient(135deg, var(--red), #FF6B6B);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 800;
            font-size: 16px;
        }

        .athlete-info h3 { font-size: 16px; font-weight: 700; }
        .athlete-info p { font-size: 12px; color: var(--gray-400); }

        .athlete-selector select {
            background: var(--gray-700);
            border: 1px solid var(--gray-600);
            color: var(--white);
            font-size: 14px;
            font-weight: 600;
            outline: none;
            cursor: pointer;
            min-width: 200px;
            padding: 10px 14px;
            border-radius: 10px;
        }

        .athlete-selector select option { background: var(--gray-800); }

        /* WORKFLOW STEPS */
        .workflow-steps {
            display: flex;
            gap: 0;
            padding: 0 40px;
            margin-top: -24px;
            position: relative;
            z-index: 2;
        }

        .workflow-step {
            flex: 1;
            background: var(--gray-800);
            padding: 20px 24px;
            border: 1px solid var(--gray-700);
            display: flex;
            align-items: center;
            gap: 16px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .workflow-step:first-child { border-radius: 16px 0 0 16px; }
        .workflow-step:last-child { border-radius: 0 16px 16px 0; }

        .workflow-step:hover { background: var(--gray-700); }
        .workflow-step.active { background: var(--gray-700); border-color: var(--red); }
        .workflow-step.completed { opacity: 0.6; }

        .step-number {
            width: 36px; height: 36px;
            border-radius: 10px;
            background: var(--gray-700);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 800;
            font-size: 14px;
        }

        .workflow-step.active .step-number { background: var(--red); }
        .workflow-step.completed .step-number { background: var(--green); }

        .step-info h4 { font-size: 13px; font-weight: 700; }
        .step-info p { font-size: 11px; color: var(--gray-400); }

        /* MAIN GRID */
        .main-grid {
            display: grid;
            grid-template-columns: 300px 1fr 380px;
            gap: 0;
            min-height: calc(100vh - 200px);
        }

        /* LEFT PANEL - EXPERTS */
        .experts-panel {
            background: var(--gray-900);
            border-right: 1px solid var(--gray-700);
            padding: 24px;
            overflow-y: auto;
        }

        .panel-title {
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            color: var(--gray-500);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .expert-card {
            background: var(--gray-800);
            border-radius: 14px;
            padding: 16px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid transparent;
            position: relative;
            overflow: hidden;
        }

        .expert-card::before {
            content: '';
            position: absolute;
            top: 0; left: 0;
            width: 4px;
            height: 100%;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .expert-card.strength::before { background: var(--red); }
        .expert-card.recovery::before { background: var(--cyan); }
        .expert-card.technique::before { background: var(--purple); }
        .expert-card.athletic::before { background: var(--green); }
        .expert-card.biomech::before { background: var(--blue); }

        .expert-card:hover::before { opacity: 1; }
        .expert-card.thinking::before { opacity: 1; }
        .expert-card.thinking { border-color: var(--gray-600); }

        .expert-header {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .expert-avatar {
            width: 42px; height: 42px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        .expert-avatar.strength { background: linear-gradient(135deg, var(--red), #B71C1C); }
        .expert-avatar.recovery { background: linear-gradient(135deg, var(--cyan), #00838F); }
        .expert-avatar.technique { background: linear-gradient(135deg, var(--purple), #6A1B9A); }
        .expert-avatar.athletic { background: linear-gradient(135deg, var(--green), #1B5E20); }
        .expert-avatar.biomech { background: linear-gradient(135deg, var(--blue), #1565C0); }

        .expert-info { flex: 1; }
        .expert-info h4 { font-size: 14px; font-weight: 700; }
        .expert-info p { font-size: 11px; color: var(--gray-400); margin-top: 2px; }

        .expert-status {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-top: 12px;
            font-size: 11px;
            color: var(--gray-500);
        }

        .status-indicator {
            width: 8px; height: 8px;
            border-radius: 50%;
            background: var(--gray-600);
        }

        .status-indicator.ready { background: var(--green); }
        .status-indicator.thinking { 
            background: var(--orange);
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.4; }
        }

        .thinking-text {
            display: none;
            color: var(--orange);
        }

        .expert-card.thinking .thinking-text { display: inline; }
        .expert-card.thinking .ready-text { display: none; }

        /* ATHLETE CONTEXT BOX */
        .athlete-context-box {
            background: var(--gray-800);
            border-radius: 14px;
            padding: 18px;
            margin-top: 20px;
            display: none;
        }

        .athlete-context-box.show { display: block; }

        .context-header {
            font-size: 12px;
            font-weight: 600;
            color: var(--gray-400);
            margin-bottom: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .context-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .context-stat {
            background: var(--gray-700);
            border-radius: 10px;
            padding: 12px;
        }

        .context-stat label { 
            font-size: 10px; 
            color: var(--gray-500); 
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .context-stat span { 
            font-size: 16px; 
            font-weight: 700; 
            display: block;
            margin-top: 4px;
        }

        /* WEARABLE DATA SECTION */
        .wearable-section {
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid var(--gray-700);
        }

        .wearable-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            font-size: 11px;
            color: var(--gray-400);
        }

        .wearable-header i { margin-right: 6px; }

        .freshness-badge {
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 9px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .freshness-badge.fresh { background: rgba(0,210,106,0.2); color: var(--green); }
        .freshness-badge.stale { background: rgba(255,152,0,0.2); color: var(--orange); }
        .freshness-badge.old { background: rgba(230,57,70,0.2); color: var(--red); }
        .freshness-badge.none { background: var(--gray-700); color: var(--gray-500); }

        .wearable-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }

        .wearable-stat {
            display: flex;
            align-items: center;
            gap: 10px;
            background: var(--gray-700);
            border-radius: 8px;
            padding: 10px;
        }

        .wearable-stat.full { grid-column: span 2; }

        .wearable-stat i { 
            color: var(--gray-500); 
            font-size: 14px;
            width: 20px;
            text-align: center;
        }

        .wearable-stat label {
            font-size: 9px;
            color: var(--gray-500);
            text-transform: uppercase;
        }

        .wearable-stat span {
            font-size: 13px;
            font-weight: 600;
            display: block;
        }

        .wearable-warning {
            margin-top: 10px;
            padding: 10px;
            background: rgba(255,152,0,0.1);
            border: 1px solid rgba(255,152,0,0.3);
            border-radius: 8px;
            font-size: 11px;
            color: var(--orange);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .wearable-warning.critical {
            background: rgba(230,57,70,0.1);
            border-color: rgba(230,57,70,0.3);
            color: var(--red);
        }

        /* MIDDLE - CONVERSATION */
        .conversation-panel {
            background: var(--black);
            display: flex;
            flex-direction: column;
        }

        .conversation-header {
            padding: 20px 24px;
            border-bottom: 1px solid var(--gray-700);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .conversation-title {
            font-weight: 700;
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .live-badge {
            background: var(--red);
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 10px;
            font-weight: 600;
            animation: pulse 2s infinite;
        }

        .phase-badge {
            background: var(--gray-800);
            padding: 8px 16px;
            border-radius: 10px;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .phase-badge i { color: var(--red); }

        .conversation-messages {
            flex: 1;
            overflow-y: auto;
            padding: 24px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .ai-message {
            display: flex;
            gap: 14px;
            animation: slideIn 0.4s ease;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(15px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .ai-message .expert-avatar {
            width: 36px; height: 36px;
            font-size: 16px;
            flex-shrink: 0;
            border-radius: 10px;
        }

        .message-bubble {
            flex: 1;
            background: var(--gray-800);
            border-radius: 4px 16px 16px 16px;
            padding: 16px 18px;
            max-width: 85%;
        }

        .message-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .message-author { 
            font-weight: 700; 
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .confidence-badge {
            font-size: 10px;
            padding: 3px 8px;
            border-radius: 10px;
            font-weight: 600;
        }

        .confidence-high { background: rgba(0,210,106,0.2); color: var(--green); }
        .confidence-medium { background: rgba(255,152,0,0.2); color: var(--orange); }

        .message-time { font-size: 11px; color: var(--gray-500); }
        .message-text { font-size: 14px; line-height: 1.7; color: var(--gray-300); }
        .message-text strong { color: var(--white); }

        /* COACH MESSAGE */
        .coach-message {
            display: flex;
            justify-content: flex-end;
            animation: slideIn 0.3s ease;
        }

        .coach-bubble {
            background: linear-gradient(135deg, var(--red), #FF6B6B);
            border-radius: 16px 4px 16px 16px;
            padding: 14px 18px;
            max-width: 70%;
        }

        .coach-bubble .message-text { color: var(--white); }

        /* TYPING INDICATOR */
        .typing-indicator {
            display: flex;
            gap: 14px;
            display: none;
        }

        .typing-indicator.show { display: flex; }

        .typing-dots {
            display: flex;
            gap: 4px;
            padding: 16px 20px;
            background: var(--gray-800);
            border-radius: 16px;
        }

        .typing-dots span {
            width: 8px; height: 8px;
            background: var(--gray-500);
            border-radius: 50%;
            animation: typingBounce 1.4s infinite;
        }

        .typing-dots span:nth-child(2) { animation-delay: 0.2s; }
        .typing-dots span:nth-child(3) { animation-delay: 0.4s; }

        @keyframes typingBounce {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-6px); }
        }

        /* COACH INPUT */
        .coach-input-area {
            padding: 20px 24px;
            border-top: 1px solid var(--gray-700);
            background: var(--gray-900);
        }

        .quick-prompts {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
            flex-wrap: wrap;
        }

        .quick-prompt {
            padding: 8px 14px;
            background: var(--gray-800);
            border: 1px solid var(--gray-700);
            border-radius: 20px;
            font-size: 12px;
            color: var(--gray-400);
            cursor: pointer;
            transition: all 0.2s;
        }

        .quick-prompt:hover {
            background: var(--gray-700);
            color: var(--white);
            border-color: var(--red);
        }

        .input-box {
            display: flex;
            gap: 12px;
            align-items: flex-end;
        }

        .coach-input {
            flex: 1;
            background: var(--gray-800);
            border: 1px solid var(--gray-700);
            border-radius: 14px;
            padding: 16px 18px;
            color: var(--white);
            font-size: 14px;
            resize: none;
            outline: none;
            min-height: 54px;
            max-height: 120px;
            font-family: inherit;
            transition: border-color 0.2s;
        }

        .coach-input:focus { border-color: var(--red); }

        .send-btn {
            width: 54px; height: 54px;
            border-radius: 14px;
            background: var(--red);
            border: none;
            color: var(--white);
            font-size: 18px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .send-btn:hover { transform: scale(1.05); background: #FF4757; }

        /* EMPTY STATE */
        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            text-align: center;
            padding: 40px;
        }

        .empty-icon {
            width: 80px; height: 80px;
            background: var(--gray-800);
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            margin-bottom: 20px;
        }

        .empty-state h3 { font-size: 18px; margin-bottom: 8px; }
        .empty-state p { color: var(--gray-500); font-size: 14px; }
    </style>
</head>
<body>
    <!-- SIDEBAR -->
    <nav class="sidebar">
        <a href="coach-dashboard.html" class="logo" style="overflow:hidden;border-radius:12px;">
            <img src="https://cdn.shopify.com/s/files/1/0969/1801/2243/files/Black_White_Bold_Modern_Clothing_Brand_Logo_97389bbf-665b-4465-82ec-d71a0fa4b35e.png?v=1758700090" alt="GR" style="width:100%;height:100%;object-fit:cover;">
        </a>
        <a href="coach-dashboard.html" class="nav-item"><i class="fas fa-th-large"></i></a>
        <a href="coach-clients.html" class="nav-item"><i class="fas fa-users"></i></a>
        <a href="coach-generate.html" class="nav-item active"><i class="fas fa-bolt"></i></a>
        <div class="nav-spacer"></div>
        <a href="#" onclick="coachLogout()" class="nav-item"><i class="fas fa-sign-out-alt"></i></a>
    </nav>

    <!-- MAIN CONTENT -->
    <main class="main">
        <!-- HERO HEADER -->
        <div class="hero-header">
            <div class="hero-content">
                <div class="hero-left">
                    <h1>üß† <span class="gradient-text">AI Workout Lab</span></h1>
                    <p class="hero-subtitle">Il tuo team di 5 esperti AI analizza, discute e genera il workout perfetto per ogni atleta</p>
                </div>
                <div class="athlete-selector">
                    <div class="athlete-avatar-lg" id="athlete-avatar">--</div>
                    <select id="athlete-select">
                        <option value="">Seleziona atleta...</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- WORKFLOW STEPS -->
        <div class="workflow-steps">
            <div class="workflow-step active" data-step="1">
                <div class="step-number">1</div>
                <div class="step-info">
                    <h4>Analisi</h4>
                    <p>Dati atleta e storico</p>
                </div>
            </div>
            <div class="workflow-step" data-step="2">
                <div class="step-number">2</div>
                <div class="step-info">
                    <h4>Consulto AI</h4>
                    <p>Discussione esperti</p>
                </div>
            </div>
            <div class="workflow-step" data-step="3">
                <div class="step-number">3</div>
                <div class="step-info">
                    <h4>Generazione</h4>
                    <p>Workout finale</p>
                </div>
            </div>
        </div>

        <!-- MAIN GRID - Continua nel prossimo step -->
        <div class="main-grid">
            <!-- LEFT: EXPERTS PANEL -->
            <div class="experts-panel">
                <div class="panel-title"><i class="fas fa-robot"></i> Team AI</div>

                <div class="expert-card strength" data-expert="strength">
                    <div class="expert-header">
                        <div class="expert-avatar strength">üí™</div>
                        <div class="expert-info">
                            <h4>Coach Strength</h4>
                            <p>Periodizzazione & Forza</p>
                        </div>
                    </div>
                    <div class="expert-status">
                        <span class="status-indicator ready"></span>
                        <span class="ready-text">Pronto</span>
                        <span class="thinking-text">Analizzando...</span>
                    </div>
                </div>

                <div class="expert-card recovery" data-expert="recovery">
                    <div class="expert-header">
                        <div class="expert-avatar recovery">üí§</div>
                        <div class="expert-info">
                            <h4>Recovery Pro</h4>
                            <p>Recupero & Fatica</p>
                        </div>
                    </div>
                    <div class="expert-status">
                        <span class="status-indicator ready"></span>
                        <span class="ready-text">Pronto</span>
                        <span class="thinking-text">Analizzando...</span>
                    </div>
                </div>

                <div class="expert-card technique" data-expert="technique">
                    <div class="expert-header">
                        <div class="expert-avatar technique">üéØ</div>
                        <div class="expert-info">
                            <h4>Tech Master</h4>
                            <p>Tecnica & Progressione</p>
                        </div>
                    </div>
                    <div class="expert-status">
                        <span class="status-indicator ready"></span>
                        <span class="ready-text">Pronto</span>
                        <span class="thinking-text">Analizzando...</span>
                    </div>
                </div>

                <div class="expert-card athletic" data-expert="athletic">
                    <div class="expert-header">
                        <div class="expert-avatar athletic">üèÉ</div>
                        <div class="expert-info">
                            <h4>Coach Athletic</h4>
                            <p>Conditioning & Cardio</p>
                        </div>
                    </div>
                    <div class="expert-status">
                        <span class="status-indicator ready"></span>
                        <span class="ready-text">Pronto</span>
                        <span class="thinking-text">Analizzando...</span>
                    </div>
                </div>

                <div class="expert-card biomech" data-expert="biomech">
                    <div class="expert-header">
                        <div class="expert-avatar biomech">ü¶¥</div>
                        <div class="expert-info">
                            <h4>Dr. Biomech</h4>
                            <p>Movimento & Postura</p>
                        </div>
                    </div>
                    <div class="expert-status">
                        <span class="status-indicator ready"></span>
                        <span class="ready-text">Pronto</span>
                        <span class="thinking-text">Analizzando...</span>
                    </div>
                </div>

                <!-- ATHLETE CONTEXT -->
                <div class="athlete-context-box" id="athlete-context">
                    <div class="context-header"><i class="fas fa-chart-line"></i> Stato Atleta</div>
                    <div class="context-stats">
                        <div class="context-stat">
                            <label>Settimana</label>
                            <span id="ctx-week">-</span>
                        </div>
                        <div class="context-stat">
                            <label>Fase</label>
                            <span id="ctx-phase">-</span>
                        </div>
                        <div class="context-stat">
                            <label>RPE Medio</label>
                            <span id="ctx-rpe">-</span>
                        </div>
                        <div class="context-stat">
                            <label>Compliance</label>
                            <span id="ctx-compliance">-</span>
                        </div>
                    </div>

                    <!-- WEARABLE DATA SECTION -->
                    <div class="wearable-section" id="wearable-section">
                        <div class="wearable-header">
                            <span><i class="fas fa-watch"></i> Dati Wearable</span>
                            <span class="freshness-badge" id="freshness-badge">-</span>
                        </div>
                        <div class="wearable-stats" id="wearable-stats">
                            <div class="wearable-stat">
                                <i class="fas fa-heartbeat"></i>
                                <div>
                                    <label>HRV</label>
                                    <span id="ctx-hrv">-</span>
                                </div>
                            </div>
                            <div class="wearable-stat">
                                <i class="fas fa-moon"></i>
                                <div>
                                    <label>Sonno</label>
                                    <span id="ctx-sleep">-</span>
                                </div>
                            </div>
                            <div class="wearable-stat full">
                                <i class="fas fa-battery-full"></i>
                                <div>
                                    <label>Readiness</label>
                                    <span id="ctx-readiness">-</span>
                                </div>
                            </div>
                        </div>
                        <div class="wearable-warning" id="wearable-warning" style="display:none;">
                            <i class="fas fa-exclamation-triangle"></i>
                            <span id="warning-text">Dati non aggiornati</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- MIDDLE: CONVERSATION -->
            <div class="conversation-panel">
                <div class="conversation-header">
                    <span class="conversation-title">
                        Discussione Team
                        <span class="live-badge" id="live-badge" style="display:none;">LIVE</span>
                    </span>
                    <div class="phase-badge" id="phase-badge">
                        <i class="fas fa-calendar-alt"></i>
                        <span id="week-label">Seleziona atleta</span>
                    </div>
                </div>

                <div class="conversation-messages" id="messages">
                    <div class="empty-state">
                        <div class="empty-icon">ü§ñ</div>
                        <h3>Seleziona un atleta</h3>
                        <p>Il team AI inizier√† ad analizzare i dati e proporre il workout</p>
                    </div>
                </div>

                <div class="typing-indicator" id="typing-indicator">
                    <div class="expert-avatar strength" id="typing-avatar">üí™</div>
                    <div class="typing-dots">
                        <span></span><span></span><span></span>
                    </div>
                </div>

                <div class="coach-input-area">
                    <div class="quick-prompts">
                        <button class="quick-prompt" onclick="quickPrompt('Pi√π volume')">üìà Pi√π volume</button>
                        <button class="quick-prompt" onclick="quickPrompt('Pi√π intensit√†')">üî• Pi√π intensit√†</button>
                        <button class="quick-prompt" onclick="quickPrompt('Settimana di scarico')">üí§ Scarico</button>
                        <button class="quick-prompt" onclick="quickPrompt('Focus tecnica')">üéØ Tecnica</button>
                    </div>
                    <div class="input-box">
                        <textarea class="coach-input" id="coach-input" placeholder="Dai indicazioni al team..." rows="1"></textarea>
                        <button class="send-btn" onclick="sendCoachMessage()"><i class="fas fa-paper-plane"></i></button>
                    </div>
                </div>
            </div>

            <!-- RIGHT: WORKOUT BUILDER -->
            <div class="workout-panel" id="workout-panel">
                <div class="workout-header">
                    <div class="workout-title-row">
                        <input type="text" class="workout-title-input" id="workout-title" value="Nuovo Workout" placeholder="Nome workout...">
                        <button class="regenerate-btn" onclick="regenerate()" title="Rigenera">
                            <i class="fas fa-sync-alt"></i>
                        </button>
                    </div>
                    <div class="workout-meta" id="workout-meta">
                        <span><i class="fas fa-dumbbell"></i> 0 esercizi</span>
                        <span><i class="fas fa-clock"></i> ~0 min</span>
                    </div>
                </div>

                <div class="workout-body" id="workout-body">
                    <div class="exercises-empty">
                        <i class="fas fa-layer-group"></i>
                        <p>Gli esercizi appariranno qui</p>
                    </div>
                </div>

                <div class="workout-actions">
                    <button class="btn-add-exercise" onclick="addExercise()">
                        <i class="fas fa-plus"></i> Aggiungi Esercizio
                    </button>
                    <button class="btn-assign" onclick="saveWorkout()">
                        <i class="fas fa-paper-plane"></i> Assegna Workout
                    </button>
                </div>
            </div>
        </div>
    </main>

    <style>
        /* WORKOUT PANEL STYLES */
        .workout-panel {
            background: var(--gray-900);
            border-left: 1px solid var(--gray-700);
            display: flex;
            flex-direction: column;
        }

        .workout-header {
            padding: 24px;
            border-bottom: 1px solid var(--gray-700);
        }

        .workout-title-row {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .workout-title-input {
            flex: 1;
            background: none;
            border: none;
            color: var(--white);
            font-size: 20px;
            font-weight: 800;
            outline: none;
        }

        .regenerate-btn {
            width: 40px; height: 40px;
            border-radius: 10px;
            background: var(--gray-800);
            border: 1px solid var(--gray-700);
            color: var(--gray-400);
            cursor: pointer;
            transition: all 0.2s;
        }

        .regenerate-btn:hover {
            background: var(--gray-700);
            color: var(--white);
            transform: rotate(180deg);
        }

        .workout-meta {
            display: flex;
            gap: 20px;
            margin-top: 10px;
            font-size: 12px;
            color: var(--gray-500);
        }

        .workout-meta i { margin-right: 6px; }

        .workout-body {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .exercises-empty {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 200px;
            color: var(--gray-600);
            text-align: center;
        }

        .exercises-empty i { font-size: 40px; margin-bottom: 12px; }
        .exercises-empty p { font-size: 13px; }

        /* EXERCISE CARD */
        .exercise-card {
            background: var(--gray-800);
            border-radius: 14px;
            padding: 16px;
            margin-bottom: 12px;
            border: 1px solid var(--gray-700);
            transition: all 0.2s;
        }

        .exercise-card:hover { border-color: var(--gray-600); }

        .exercise-top {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .exercise-drag {
            color: var(--gray-600);
            cursor: grab;
            padding: 4px;
        }

        .exercise-name {
            flex: 1;
            font-weight: 700;
            font-size: 14px;
        }

        .exercise-type {
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .type-strength { background: rgba(230,57,70,0.2); color: var(--red); }
        .type-hypertrophy { background: rgba(156,39,176,0.2); color: var(--purple); }
        .type-conditioning { background: rgba(0,188,212,0.2); color: var(--cyan); }

        .exercise-params {
            display: flex;
            gap: 12px;
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid var(--gray-700);
        }

        .param-group {
            flex: 1;
            text-align: center;
        }

        .param-label {
            font-size: 10px;
            color: var(--gray-500);
            text-transform: uppercase;
            margin-bottom: 4px;
        }

        .param-value {
            font-size: 16px;
            font-weight: 700;
        }

        .exercise-actions {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }

        .ex-btn {
            flex: 1;
            padding: 8px;
            border-radius: 8px;
            background: var(--gray-700);
            border: none;
            color: var(--gray-400);
            font-size: 11px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .ex-btn:hover { background: var(--gray-600); color: var(--white); }
        .ex-btn.delete:hover { background: rgba(230,57,70,0.3); color: var(--red); }

        /* WORKOUT ACTIONS */
        .workout-actions {
            padding: 20px;
            border-top: 1px solid var(--gray-700);
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .btn-add-exercise {
            width: 100%;
            padding: 14px;
            border-radius: 12px;
            background: var(--gray-800);
            border: 2px dashed var(--gray-600);
            color: var(--gray-400);
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-add-exercise:hover {
            border-color: var(--red);
            color: var(--red);
        }

        .btn-assign {
            width: 100%;
            padding: 16px;
            border-radius: 12px;
            background: var(--white);
            border: none;
            color: var(--black);
            font-size: 14px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .btn-assign:hover { transform: translateY(-2px); box-shadow: 0 8px 24px rgba(255,255,255,0.1); }

        /* RESPONSIVE */
        @media (max-width: 1400px) {
            .main-grid { grid-template-columns: 280px 1fr 340px; }
        }

        @media (max-width: 1100px) {
            .main-grid { grid-template-columns: 1fr; }
            .experts-panel, .workout-panel { display: none; }
        }

        @media (max-width: 768px) {
            .sidebar { 
                width: 100%; height: 64px;
                bottom: 0; top: auto;
                flex-direction: row;
                padding: 0 16px;
                justify-content: space-around;
            }
            .logo { margin-bottom: 0; width: 36px; height: 36px; }
            .nav-item { margin-bottom: 0; }
            .nav-spacer { display: none; }
            .main { margin-left: 0; margin-bottom: 64px; }
            .hero-header { padding: 24px 20px; }
            .hero-content { flex-direction: column; gap: 20px; }
            .workflow-steps { flex-direction: column; margin: 20px 20px 0; padding: 0; }
            .workflow-step { border-radius: 12px !important; margin-bottom: 8px; }
        }
    </style>

    <script src="js/supabase-client.js"></script>
    <script>
        // Check if coach is logged in
        if (localStorage.getItem('gr_coach_logged_in') !== 'true') {
            window.location.href = 'coach-login.html';
        }

        // Logout function
        function coachLogout() {
            localStorage.removeItem('gr_coach_logged_in');
            localStorage.removeItem('gr_coach_email');
            localStorage.removeItem('gr_coach_name');
            localStorage.removeItem('gr_coach_last_active');
            window.location.href = 'coach-login.html';
        }
        // STATE
        let selectedAthlete = null;
        let athletes = [];
        let currentWorkout = { exercises: [] };
        let currentWeek = 1;
        let currentPhase = 'Adattamento';

        // AI EXPERTS CONFIG
        const experts = {
            strength: { name: 'Coach Strength', avatar: 'üí™', class: 'strength', color: '#E63946' },
            recovery: { name: 'Recovery Pro', avatar: 'üí§', class: 'recovery', color: '#00BCD4' },
            technique: { name: 'Tech Master', avatar: 'üéØ', class: 'technique', color: '#9C27B0' },
            athletic: { name: 'Coach Athletic', avatar: 'üèÉ', class: 'athletic', color: '#00D26A' },
            biomech: { name: 'Dr. Biomech', avatar: 'ü¶¥', class: 'biomech', color: '#2196F3' }
        };

        // EXERCISE DATABASE
        const exerciseDB = {
            adattamento: [
                { name: 'Goblet Squat', sets: 3, reps: '12', type: 'hypertrophy' },
                { name: 'Push-ups', sets: 3, reps: '10-15', type: 'hypertrophy' },
                { name: 'TRX Row', sets: 3, reps: '12', type: 'hypertrophy' },
                { name: 'Plank', sets: 3, reps: '30s', type: 'conditioning' }
            ],
            accumulo: [
                { name: 'Back Squat', sets: 4, reps: '8', type: 'strength' },
                { name: 'Bench Press', sets: 4, reps: '8', type: 'strength' },
                { name: 'Barbell Row', sets: 4, reps: '8', type: 'strength' },
                { name: 'Romanian Deadlift', sets: 3, reps: '10', type: 'hypertrophy' },
                { name: 'Shoulder Press', sets: 3, reps: '10', type: 'hypertrophy' }
            ],
            intensificazione: [
                { name: 'Back Squat', sets: 5, reps: '3-5', type: 'strength' },
                { name: 'Deadlift', sets: 4, reps: '3', type: 'strength' },
                { name: 'Bench Press', sets: 5, reps: '3-5', type: 'strength' },
                { name: 'Weighted Pull-ups', sets: 4, reps: '5', type: 'strength' }
            ],
            deload: [
                { name: 'Goblet Squat', sets: 2, reps: '10', type: 'hypertrophy' },
                { name: 'Light DB Press', sets: 2, reps: '12', type: 'hypertrophy' },
                { name: 'Band Pull-aparts', sets: 3, reps: '15', type: 'conditioning' },
                { name: 'Mobility Flow', sets: 1, reps: '10min', type: 'conditioning' }
            ]
        };

        // INIT
        document.addEventListener('DOMContentLoaded', async () => {
            await loadAthletes();
            setupEventListeners();
            checkUrlParams();
        });

        async function loadAthletes() {
            athletes = await supabase.fetch('athletes', '?select=*&order=first_name.asc');
            const select = document.getElementById('athlete-select');
            athletes.forEach(a => {
                const option = document.createElement('option');
                option.value = a.id;
                option.textContent = `${a.first_name} ${a.last_name}`;
                select.appendChild(option);
            });
        }

        function setupEventListeners() {
            document.getElementById('athlete-select').addEventListener('change', onAthleteSelect);
            
            document.getElementById('coach-input').addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendCoachMessage();
                }
            });
        }

        function checkUrlParams() {
            const urlParams = new URLSearchParams(window.location.search);
            const athleteId = urlParams.get('athlete');
            if (athleteId) {
                document.getElementById('athlete-select').value = athleteId;
                onAthleteSelect({ target: { value: athleteId } });
            }
        }

        // ATHLETE SELECTION
        async function onAthleteSelect(e) {
            const id = e.target.value;
            if (!id) return;

            selectedAthlete = athletes.find(a => a.id === id);
            
            // Update avatar
            const initials = (selectedAthlete.first_name?.[0] || '') + (selectedAthlete.last_name?.[0] || '');
            document.getElementById('athlete-avatar').textContent = initials;

            // Show context box
            document.getElementById('athlete-context').classList.add('show');
            document.getElementById('live-badge').style.display = 'inline';

            // Update workflow step
            setWorkflowStep(1);

            // Load athlete data
            const workouts = await supabase.fetch('workouts', `?athlete_id=eq.${id}&select=*`);
            const feedback = await supabase.fetch('feedback', `?athlete_id=eq.${id}&select=*&order=created_at.desc&limit=5`);
            
            // Load wearable data
            const wearableData = await loadWearableData(id);

            // Calculate current week and phase
            currentWeek = Math.min(8, Math.max(1, Math.ceil((workouts.length + 1) / 3)));
            currentPhase = getPhase(currentWeek);
            
            // Calculate stats
            const avgRpe = feedback.length 
                ? (feedback.reduce((s, f) => s + (f.rpe || 7), 0) / feedback.length).toFixed(1) 
                : '7.0';
            const compliance = workouts.length 
                ? Math.round((workouts.filter(w => w.completed).length / workouts.length) * 100) 
                : 100;

            // Update UI
            document.getElementById('ctx-week').textContent = `${currentWeek}/8`;
            document.getElementById('ctx-phase').textContent = currentPhase;
            document.getElementById('ctx-rpe').textContent = avgRpe;
            document.getElementById('ctx-compliance').textContent = `${compliance}%`;
            document.getElementById('week-label').textContent = `Sett. ${currentWeek} - ${currentPhase}`;

            // Start AI consultation with wearable data
            startConsultation(currentPhase, avgRpe, compliance, wearableData);
        }
        
        // WEARABLE DATA LOADING WITH FRESHNESS CHECK
        async function loadWearableData(athleteId) {
            try {
                // Try to fetch wearable data from Supabase
                const biometrics = await supabase.fetch('biometrics', `?athlete_id=eq.${athleteId}&order=created_at.desc&limit=1`);
                
                if (!biometrics || biometrics.length === 0) {
                    // No wearable connected
                    updateWearableUI(null);
                    return { hasData: false, status: 'none' };
                }
                
                const data = biometrics[0];
                const lastSync = new Date(data.created_at || data.synced_at);
                const now = new Date();
                const hoursAgo = (now - lastSync) / (1000 * 60 * 60);
                
                // Determine freshness status
                let freshness = { status: 'fresh', label: '< 24h', usable: true };
                
                if (hoursAgo > 72) {
                    freshness = { status: 'old', label: '> 3 giorni', usable: false };
                } else if (hoursAgo > 24) {
                    freshness = { status: 'stale', label: `${Math.round(hoursAgo)}h fa`, usable: true };
                } else {
                    freshness = { status: 'fresh', label: 'Aggiornato', usable: true };
                }
                
                const result = {
                    hasData: true,
                    usable: freshness.usable,
                    status: freshness.status,
                    hoursAgo: hoursAgo,
                    hrv: data.hrv_average || data.hrv,
                    hrvTrend: data.hrv_trend,
                    sleep: data.sleep_hours || data.sleep_duration,
                    sleepQuality: data.sleep_quality,
                    readiness: data.readiness_score || data.readiness,
                    rhr: data.resting_hr || data.rhr,
                    source: data.source || 'Wearable'
                };
                
                updateWearableUI(result, freshness);
                return result;
                
            } catch (error) {
                console.log('No wearable data available');
                updateWearableUI(null);
                return { hasData: false, status: 'none' };
            }
        }
        
        function updateWearableUI(data, freshness = null) {
            const badge = document.getElementById('freshness-badge');
            const warning = document.getElementById('wearable-warning');
            
            if (!data || !data.hasData) {
                // No wearable
                badge.textContent = 'Non connesso';
                badge.className = 'freshness-badge none';
                document.getElementById('ctx-hrv').textContent = '-';
                document.getElementById('ctx-sleep').textContent = '-';
                document.getElementById('ctx-readiness').textContent = '-';
                warning.style.display = 'none';
                return;
            }
            
            // Update badge
            badge.textContent = freshness.label;
            badge.className = `freshness-badge ${freshness.status}`;
            
            // Update stats
            document.getElementById('ctx-hrv').textContent = data.hrv ? `${data.hrv} ms` : '-';
            document.getElementById('ctx-sleep').textContent = data.sleep ? `${data.sleep}h` : '-';
            document.getElementById('ctx-readiness').textContent = data.readiness ? `${data.readiness}/100` : '-';
            
            // Show warning if data is stale or old
            if (freshness.status === 'stale') {
                warning.style.display = 'flex';
                warning.classList.remove('critical');
                document.getElementById('warning-text').textContent = 
                    `Dati di ${Math.round(data.hoursAgo)}h fa - Uso con cautela`;
            } else if (freshness.status === 'old') {
                warning.style.display = 'flex';
                warning.classList.add('critical');
                document.getElementById('warning-text').textContent = 
                    `Dati troppo vecchi (${Math.round(data.hoursAgo/24)} giorni) - Ignoro, uso solo RPE`;
            } else {
                warning.style.display = 'none';
            }
        }

        function getPhase(week) {
            if (week <= 2) return 'Adattamento';
            if (week <= 4) return 'Accumulo';
            if (week <= 6) return 'Intensificazione';
            if (week <= 7) return 'Peaking';
            return 'Deload';
        }

        function setWorkflowStep(step) {
            document.querySelectorAll('.workflow-step').forEach((el, i) => {
                el.classList.remove('active', 'completed');
                if (i + 1 < step) el.classList.add('completed');
                if (i + 1 === step) el.classList.add('active');
            });
        }

        // AI CONSULTATION
        function startConsultation(phase, avgRpe, compliance, wearableData = null) {
            const messages = document.getElementById('messages');
            messages.innerHTML = '';
            setWorkflowStep(2);

            // Simulate expert thinking
            setExpertThinking('strength', true);

            setTimeout(() => {
                setExpertThinking('strength', false);
                addAIMessage('strength', 
                    `Analizziamo <strong>${selectedAthlete.first_name}</strong>. Siamo in <strong>settimana ${currentWeek}</strong>, fase di <strong>${phase}</strong>. ${getPhaseDescription(phase)}`,
                    'high'
                );
                setExpertThinking('recovery', true);
            }, 800);

            setTimeout(() => {
                setExpertThinking('recovery', false);
                
                // Build recovery message based on wearable data freshness
                let recoveryMessage = '';
                
                if (wearableData && wearableData.hasData && wearableData.usable) {
                    // Fresh or stale (but usable) wearable data
                    const hrvInfo = wearableData.hrv ? `HRV <strong>${wearableData.hrv}ms</strong>` : '';
                    const sleepInfo = wearableData.sleep ? `Sonno <strong>${wearableData.sleep}h</strong>` : '';
                    const readinessInfo = wearableData.readiness ? `Readiness <strong>${wearableData.readiness}/100</strong>` : '';
                    
                    const dataPoints = [hrvInfo, sleepInfo, readinessInfo].filter(x => x).join(', ');
                    
                    if (wearableData.status === 'stale') {
                        recoveryMessage = `‚ö†Ô∏è Dati wearable di ${Math.round(wearableData.hoursAgo)}h fa: ${dataPoints}. Li considero con cautela. RPE medio <strong>${avgRpe}</strong>.`;
                    } else {
                        recoveryMessage = `üìä Dati wearable freschi: ${dataPoints}. RPE medio <strong>${avgRpe}</strong>, compliance <strong>${compliance}%</strong>.`;
                        
                        // Add specific recommendations based on data
                        if (wearableData.readiness && wearableData.readiness < 50) {
                            recoveryMessage += ' <strong>Readiness bassa</strong> - consiglio sessione pi√π leggera.';
                        } else if (wearableData.readiness && wearableData.readiness >= 80) {
                            recoveryMessage += ' <strong>Readiness ottima</strong> - puoi spingere!';
                        }
                    }
                } else if (wearableData && wearableData.hasData && !wearableData.usable) {
                    // Data too old - ignore
                    recoveryMessage = `‚ùå I dati wearable sono di <strong>${Math.round(wearableData.hoursAgo/24)} giorni fa</strong>, troppo vecchi. Mi baso sul <strong>feedback manuale</strong>: RPE medio <strong>${avgRpe}</strong>, compliance <strong>${compliance}%</strong>.`;
                } else {
                    // No wearable connected
                    const rpeComment = avgRpe > 8 
                        ? 'L\'RPE alto suggerisce di <strong>moderare il volume</strong>.' 
                        : 'L\'RPE √® gestibile, possiamo mantenere l\'intensit√† programmata.';
                    recoveryMessage = `Nessun wearable connesso. Mi baso sul feedback: RPE medio <strong>${avgRpe}</strong>, compliance <strong>${compliance}%</strong>. ${rpeComment}`;
                }
                
                addAIMessage('recovery', recoveryMessage, wearableData?.usable ? 'high' : 'medium');
                setExpertThinking('technique', true);
            }, 2000);

            setTimeout(() => {
                setExpertThinking('technique', false);
                addAIMessage('technique', 
                    `Ho preparato una struttura ottimale per questa fase. Vuoi modificare qualcosa prima di generare?`,
                    'medium'
                );
                setWorkflowStep(3);
                generateWorkout(phase);
            }, 3200);
        }

        function setExpertThinking(expertKey, isThinking) {
            const card = document.querySelector(`.expert-card[data-expert="${expertKey}"]`);
            const indicator = card.querySelector('.status-indicator');
            
            if (isThinking) {
                card.classList.add('thinking');
                indicator.classList.remove('ready');
                indicator.classList.add('thinking');
                showTypingIndicator(expertKey);
            } else {
                card.classList.remove('thinking');
                indicator.classList.remove('thinking');
                indicator.classList.add('ready');
                hideTypingIndicator();
            }
        }

        function showTypingIndicator(expertKey) {
            const expert = experts[expertKey];
            const indicator = document.getElementById('typing-indicator');
            const avatar = document.getElementById('typing-avatar');
            
            avatar.textContent = expert.avatar;
            avatar.className = `expert-avatar ${expert.class}`;
            indicator.classList.add('show');
        }

        function hideTypingIndicator() {
            document.getElementById('typing-indicator').classList.remove('show');
        }

        function getPhaseDescription(phase) {
            const desc = {
                'Adattamento': 'Focus su <strong>tecnica</strong> e costruzione della base. Carichi 60-70%.',
                'Accumulo': 'Volume elevato per <strong>ipertrofia</strong>. Carichi 70-80%.',
                'Intensificazione': 'Carichi <strong>pesanti</strong>, volume ridotto. Focus forza 80-90%.',
                'Peaking': 'Preparazione test/gara. Volume minimo, <strong>intensit√† massima</strong>.',
                'Deload': 'Settimana di <strong>scarico</strong>. Recupero attivo 50-60%.'
            };
            return desc[phase] || '';
        }

        // MESSAGES
        function addAIMessage(expertKey, text, confidence = 'high') {
            const expert = experts[expertKey];
            const messages = document.getElementById('messages');
            
            const confidenceLabel = confidence === 'high' ? 'Alta confidenza' : 'Media confidenza';
            const confidenceClass = confidence === 'high' ? 'confidence-high' : 'confidence-medium';
            
            messages.insertAdjacentHTML('beforeend', `
                <div class="ai-message">
                    <div class="expert-avatar ${expert.class}">${expert.avatar}</div>
                    <div class="message-bubble">
                        <div class="message-header">
                            <span class="message-author">
                                ${expert.name}
                                <span class="confidence-badge ${confidenceClass}">${confidenceLabel}</span>
                            </span>
                            <span class="message-time">${new Date().toLocaleTimeString('it-IT', { hour: '2-digit', minute: '2-digit' })}</span>
                        </div>
                        <div class="message-text">${text}</div>
                    </div>
                </div>
            `);
            
            messages.scrollTop = messages.scrollHeight;
        }

        function addCoachMessage(text) {
            const messages = document.getElementById('messages');
            messages.insertAdjacentHTML('beforeend', `
                <div class="coach-message">
                    <div class="coach-bubble">
                        <div class="message-text">${text}</div>
                    </div>
                </div>
            `);
            messages.scrollTop = messages.scrollHeight;
        }

        // COACH INTERACTION
        function sendCoachMessage() {
            const input = document.getElementById('coach-input');
            const text = input.value.trim();
            if (!text) return;

            addCoachMessage(text);
            input.value = '';

            // AI Response
            setTimeout(() => processCoachInput(text.toLowerCase()), 600);
        }

        function quickPrompt(text) {
            document.getElementById('coach-input').value = text;
            sendCoachMessage();
        }

        function processCoachInput(text) {
            setExpertThinking('strength', true);

            setTimeout(() => {
                setExpertThinking('strength', false);

                if (text.includes('deload') || text.includes('scarico') || text.includes('recupero')) {
                    addAIMessage('recovery', 'Capito! Adatto il piano per una settimana di <strong>scarico</strong>. Volume -40%, intensit√† 60-70%.', 'high');
                    generateWorkout('Deload');
                } else if (text.includes('pesante') || text.includes('intenso') || text.includes('intensit√†') || text.includes('forza')) {
                    addAIMessage('strength', 'Perfetto! Aumento l\'intensit√† a <strong>85-90%</strong>. Meno volume, pi√π carico.', 'high');
                    generateWorkout('Intensificazione');
                } else if (text.includes('volume') || text.includes('ipertrofia')) {
                    addAIMessage('strength', 'Ok! Struttura orientata al <strong>volume</strong>: 4 serie, 8-12 reps, carichi moderati.', 'high');
                    generateWorkout('Accumulo');
                } else if (text.includes('tecnica') || text.includes('base')) {
                    addAIMessage('technique', 'Inserisco esercizi propedeutici con focus sulla <strong>qualit√† del movimento</strong>.', 'high');
                    generateWorkout('Adattamento');
                } else {
                    addAIMessage('strength', 'Ricevuto! Ho aggiornato la scheda in base alle tue indicazioni.', 'medium');
                }
            }, 800);
        }

        // WORKOUT GENERATION
        function generateWorkout(phase) {
            const phaseKey = phase.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
            const exercises = exerciseDB[phaseKey] || exerciseDB.accumulo;
            
            currentWorkout.exercises = [...exercises];
            renderExercises();
            document.getElementById('workout-title').value = `${phase} - Sett. ${currentWeek}`;
        }

        function renderExercises() {
            const container = document.getElementById('workout-body');
            
            if (currentWorkout.exercises.length === 0) {
                container.innerHTML = `
                    <div class="exercises-empty">
                        <i class="fas fa-layer-group"></i>
                        <p>Gli esercizi appariranno qui</p>
                    </div>
                `;
                updateMeta();
                return;
            }

            container.innerHTML = currentWorkout.exercises.map((ex, i) => `
                <div class="exercise-card">
                    <div class="exercise-top">
                        <span class="exercise-drag"><i class="fas fa-grip-vertical"></i></span>
                        <span class="exercise-name">${ex.name}</span>
                        <span class="exercise-type type-${ex.type}">${ex.type}</span>
                    </div>
                    <div class="exercise-params">
                        <div class="param-group">
                            <div class="param-label">Serie</div>
                            <div class="param-value">${ex.sets}</div>
                        </div>
                        <div class="param-group">
                            <div class="param-label">Reps</div>
                            <div class="param-value">${ex.reps}</div>
                        </div>
                        <div class="param-group">
                            <div class="param-label">Rest</div>
                            <div class="param-value">90s</div>
                        </div>
                    </div>
                    <div class="exercise-actions">
                        <button class="ex-btn" onclick="editExercise(${i})"><i class="fas fa-edit"></i> Modifica</button>
                        <button class="ex-btn delete" onclick="removeExercise(${i})"><i class="fas fa-trash"></i></button>
                    </div>
                </div>
            `).join('');

            updateMeta();
        }

        function updateMeta() {
            const count = currentWorkout.exercises.length;
            const duration = count * 8;
            document.getElementById('workout-meta').innerHTML = `
                <span><i class="fas fa-dumbbell"></i> ${count} esercizi</span>
                <span><i class="fas fa-clock"></i> ~${duration} min</span>
            `;
        }

        function addExercise() {
            const allExercises = ['Squat', 'Deadlift', 'Bench Press', 'Pull-ups', 'Rows', 'Lunges', 'Shoulder Press', 'Dips'];
            const random = allExercises[Math.floor(Math.random() * allExercises.length)];
            
            currentWorkout.exercises.push({ name: random, sets: 3, reps: '10', type: 'strength' });
            renderExercises();
            
            addAIMessage('strength', `Aggiunto <strong>${random}</strong>. Vuoi regolare serie e ripetizioni?`, 'medium');
        }

        function removeExercise(index) {
            currentWorkout.exercises.splice(index, 1);
            renderExercises();
        }

        function editExercise(index) {
            // TODO: Modal per editing
            alert('Editing in arrivo!');
        }

        function regenerate() {
            if (!selectedAthlete) return;
            generateWorkout(currentPhase);
            addAIMessage('strength', 'Ho rigenerato la scheda con <strong>nuove varianti</strong>. Che ne pensi?', 'high');
        }

        // SAVE WORKOUT
        async function saveWorkout() {
            if (!selectedAthlete || !currentWorkout.exercises.length) {
                alert('Seleziona atleta e aggiungi esercizi');
                return;
            }

            const workout = {
                athlete_id: selectedAthlete.id,
                name: document.getElementById('workout-title').value,
                type: 'ai_generated',
                exercises: currentWorkout.exercises,
                duration: currentWorkout.exercises.length * 8,
                week: currentWeek,
                status: 'assigned'
            };

            const result = await supabase.insert('workouts', workout);
            
            if (result && !result.error) {
                addAIMessage('strength', `‚úÖ Workout assegnato con successo a <strong>${selectedAthlete.first_name}</strong>!`, 'high');
                
                // Success animation
                const btn = document.querySelector('.btn-assign');
                btn.innerHTML = '<i class="fas fa-check"></i> Assegnato!';
                btn.style.background = '#00D26A';
                
                setTimeout(() => {
                    btn.innerHTML = '<i class="fas fa-paper-plane"></i> Assegna Workout';
                    btn.style.background = '';
                }, 2000);
            } else {
                alert('Errore nel salvataggio');
            }
        }
    </script>
</body>
</html>
