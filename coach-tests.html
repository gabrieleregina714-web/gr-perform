<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GR Perform - Test Fisici</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        :root {
            --red: #E63946;
            --black: #000;
            --gray-900: #0A0A0A;
            --gray-800: #111;
            --gray-700: #1A1A1A;
            --gray-600: #222;
            --gray-400: #888;
            --gray-500: #666;
            --white: #FFF;
            --green: #00D26A;
            --yellow: #FFB800;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--black);
            color: var(--white);
            overflow-x: hidden;
        }

        /* SIDEBAR */
        .sidebar {
            position: fixed;
            left: 0; top: 0;
            width: 72px; height: 100vh;
            background: var(--gray-900);
            border-right: 1px solid var(--gray-600);
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px 0;
            z-index: 100;
        }

        .logo {
            width: 44px; height: 44px;
            background: linear-gradient(135deg, #E63946, #FF6B6B);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 900;
            margin-bottom: 40px;
            cursor: pointer;
        }

        .nav-item {
            width: 44px; height: 44px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--gray-500);
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.2s;
            text-decoration: none;
            position: relative;
        }

        .nav-item:hover { background: var(--gray-700); color: var(--white); }
        .nav-item.active { background: var(--gray-700); color: var(--white); }
        .nav-item.active::before {
            content: '';
            position: absolute;
            left: 0;
            width: 3px;
            height: 24px;
            background: var(--red);
            border-radius: 0 2px 2px 0;
        }

        .nav-spacer { flex: 1; }

        /* MAIN */
        .main { 
            margin-left: 72px; 
            min-height: 100vh;
            padding: 32px;
        }

        /* HEADER */
        .page-header {
            margin-bottom: 32px;
        }

        .page-title {
            font-size: 28px;
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: -1px;
            margin-bottom: 8px;
        }

        .page-subtitle {
            color: var(--gray-400);
            font-size: 14px;
        }

        /* SELECT ATHLETE */
        .section {
            margin-bottom: 32px;
        }

        .section-title {
            font-size: 12px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 2px;
            color: var(--gray-400);
            margin-bottom: 16px;
        }

        .athlete-select {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 12px;
        }

        .athlete-card {
            background: var(--gray-800);
            border: 2px solid var(--gray-600);
            border-radius: 12px;
            padding: 16px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .athlete-card:hover {
            border-color: var(--gray-400);
        }

        .athlete-card.selected {
            border-color: var(--red);
            background: rgba(230, 57, 70, 0.1);
        }

        .athlete-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: var(--gray-600);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 18px;
        }

        .athlete-info h4 {
            font-weight: 600;
            margin-bottom: 4px;
        }

        .athlete-info p {
            font-size: 12px;
            color: var(--gray-400);
        }

        /* TEST FORM */
        .test-form {
            background: var(--gray-800);
            border: 1px solid var(--gray-600);
            border-radius: 16px;
            padding: 24px;
            display: none;
        }

        .test-form.visible {
            display: block;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .form-group label {
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--gray-400);
        }

        .form-group select,
        .form-group input {
            background: var(--gray-700);
            border: 1px solid var(--gray-600);
            border-radius: 8px;
            padding: 12px 16px;
            color: var(--white);
            font-family: inherit;
            font-size: 14px;
            transition: border-color 0.2s;
        }

        .form-group select:focus,
        .form-group input:focus {
            outline: none;
            border-color: var(--red);
        }

        .form-group select option {
            background: var(--gray-700);
        }

        /* AVAILABLE TESTS */
        .available-tests {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 10px;
            margin-bottom: 24px;
        }

        .test-chip {
            background: var(--gray-700);
            border: 1px solid var(--gray-600);
            border-radius: 8px;
            padding: 12px 16px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .test-chip:hover {
            border-color: var(--gray-400);
        }

        .test-chip.selected {
            border-color: var(--red);
            background: rgba(230, 57, 70, 0.15);
        }

        .test-chip i {
            color: var(--red);
        }

        .test-chip-info {
            flex: 1;
        }

        .test-chip-name {
            font-weight: 600;
            font-size: 13px;
        }

        .test-chip-unit {
            font-size: 11px;
            color: var(--gray-400);
        }

        /* TEST VALUE INPUT */
        .test-values-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 12px;
            margin-bottom: 24px;
        }

        .test-value-card {
            background: var(--gray-700);
            border: 1px solid var(--gray-600);
            border-radius: 10px;
            padding: 16px;
        }

        .test-value-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .test-value-name {
            font-weight: 600;
            font-size: 13px;
        }

        .test-value-remove {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: var(--gray-600);
            border: none;
            color: var(--gray-400);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
        }

        .test-value-remove:hover {
            background: var(--red);
            color: var(--white);
        }

        .test-value-input {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .test-value-input input {
            flex: 1;
            background: var(--gray-800);
            border: 1px solid var(--gray-600);
            border-radius: 8px;
            padding: 10px 14px;
            color: var(--white);
            font-family: inherit;
            font-size: 16px;
            font-weight: 600;
        }

        .test-value-input input:focus {
            outline: none;
            border-color: var(--red);
        }

        .test-value-unit {
            font-size: 13px;
            color: var(--gray-400);
            min-width: 40px;
        }

        /* BUTTONS */
        .btn {
            padding: 14px 28px;
            border-radius: 8px;
            font-weight: 700;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 1px;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
            display: inline-flex;
            align-items: center;
            gap: 10px;
        }

        .btn-primary {
            background: var(--red);
            color: var(--white);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(230, 57, 70, 0.3);
        }

        .btn-secondary {
            background: var(--gray-700);
            color: var(--white);
        }

        .btn-secondary:hover {
            background: var(--gray-600);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }

        .form-actions {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            padding-top: 20px;
            border-top: 1px solid var(--gray-600);
        }

        /* HISTORY */
        .history-table {
            width: 100%;
            border-collapse: collapse;
        }

        .history-table th,
        .history-table td {
            padding: 14px 16px;
            text-align: left;
            border-bottom: 1px solid var(--gray-600);
        }

        .history-table th {
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--gray-400);
            background: var(--gray-800);
        }

        .history-table td {
            font-size: 14px;
        }

        .history-table tr:hover td {
            background: var(--gray-800);
        }

        .history-value {
            font-weight: 700;
            color: var(--green);
        }

        /* SUCCESS MESSAGE */
        .success-toast {
            position: fixed;
            bottom: 32px;
            right: 32px;
            background: var(--green);
            color: #000;
            padding: 16px 24px;
            border-radius: 12px;
            font-weight: 600;
            display: none;
            align-items: center;
            gap: 10px;
            z-index: 1000;
            animation: slideIn 0.3s ease;
        }

        .success-toast.show {
            display: flex;
        }

        @keyframes slideIn {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        /* EMPTY STATE */
        .empty-state {
            text-align: center;
            padding: 48px;
            color: var(--gray-400);
        }

        .empty-state i {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        /* RESPONSIVE */
        @media (max-width: 768px) {
            .sidebar {
                width: 100%;
                height: 60px;
                flex-direction: row;
                position: fixed;
                bottom: 0;
                top: auto;
                padding: 0 16px;
                justify-content: space-around;
            }

            .logo { display: none; }
            .nav-spacer { display: none; }
            .nav-item { margin: 0; }

            .main {
                margin-left: 0;
                margin-bottom: 60px;
                padding: 20px 16px;
            }

            .page-title { font-size: 22px; }
        }
    </style>
</head>
<body>
    <!-- SIDEBAR -->
    <nav class="sidebar">
        <a href="coach-dashboard.html" class="logo">GR</a>
        <a href="coach-dashboard.html" class="nav-item"><i class="fas fa-home"></i></a>
        <a href="coach-team.html" class="nav-item"><i class="fas fa-users"></i></a>
        <a href="coach-generate.html" class="nav-item"><i class="fas fa-magic"></i></a>
        <a href="coach-tests.html" class="nav-item active"><i class="fas fa-clipboard-check"></i></a>
        <a href="coach-chat.html" class="nav-item"><i class="fas fa-comments"></i></a>
        <div class="nav-spacer"></div>
        <a href="coach-login.html" class="nav-item"><i class="fas fa-sign-out-alt"></i></a>
    </nav>

    <!-- MAIN -->
    <main class="main">
        <div class="page-header">
            <h1 class="page-title">Test Fisici</h1>
            <p class="page-subtitle">Registra i risultati dei test per monitorare i progressi degli atleti</p>
        </div>

        <!-- SELECT ATHLETE -->
        <section class="section">
            <h2 class="section-title">Seleziona Atleta</h2>
            <div class="athlete-select" id="athleteList">
                <div class="empty-state">
                    <i class="fas fa-spinner fa-spin"></i>
                    <p>Caricamento atleti...</p>
                </div>
            </div>
        </section>

        <!-- TEST FORM -->
        <section class="test-form" id="testForm">
            <h2 class="section-title">Nuovo Test per <span id="selectedAthleteName">-</span></h2>
            
            <div class="form-row">
                <div class="form-group">
                    <label>Data Test</label>
                    <input type="date" id="testDate">
                </div>
                <div class="form-group">
                    <label>Note (opzionale)</label>
                    <input type="text" id="testNotes" placeholder="Es: Test post-vacanze">
                </div>
            </div>

            <h3 class="section-title" style="margin-top: 24px;">Test Disponibili</h3>
            <p style="color: var(--gray-400); font-size: 13px; margin-bottom: 16px;">
                Seleziona i test da registrare per questo atleta
            </p>
            <div class="available-tests" id="availableTests">
                <!-- Generated by JS -->
            </div>

            <h3 class="section-title">Valori Test</h3>
            <div class="test-values-grid" id="testValuesGrid">
                <div class="empty-state" style="grid-column: 1/-1; padding: 24px;">
                    <p>Seleziona i test da registrare</p>
                </div>
            </div>

            <div class="form-actions">
                <button class="btn btn-secondary" onclick="cancelTest()">Annulla</button>
                <button class="btn btn-primary" id="saveBtn" onclick="saveTests()" disabled>
                    <i class="fas fa-save"></i> Salva Test
                </button>
            </div>
        </section>

        <!-- HISTORY -->
        <section class="section" id="historySection" style="display: none;">
            <h2 class="section-title">Storico Test</h2>
            <div style="background: var(--gray-800); border-radius: 12px; overflow: hidden;">
                <table class="history-table">
                    <thead>
                        <tr>
                            <th>Data</th>
                            <th>Test</th>
                            <th>Valore</th>
                            <th>Note</th>
                        </tr>
                    </thead>
                    <tbody id="historyBody">
                    </tbody>
                </table>
            </div>
        </section>
    </main>

    <!-- SUCCESS TOAST -->
    <div class="success-toast" id="successToast">
        <i class="fas fa-check-circle"></i>
        <span>Test salvati con successo!</span>
    </div>

    <script src="js/supabase-client.js"></script>
    <script>
        let athletes = [];
        let selectedAthlete = null;
        let selectedTests = {};
        let testCatalog = [];

        // Test catalog (hardcoded per ora, poi da database)
        const defaultTestCatalog = [
            // FORZA
            { category: 'forza', name: 'squat_1rm', label: 'Squat 1RM', unit: 'kg' },
            { category: 'forza', name: 'bench_1rm', label: 'Bench Press 1RM', unit: 'kg' },
            { category: 'forza', name: 'deadlift_1rm', label: 'Deadlift 1RM', unit: 'kg' },
            { category: 'forza', name: 'ohp_1rm', label: 'OHP 1RM', unit: 'kg' },
            
            // VELOCITA
            { category: 'velocita', name: 'sprint_10m', label: 'Sprint 10m', unit: 'sec' },
            { category: 'velocita', name: 'sprint_30m', label: 'Sprint 30m', unit: 'sec' },
            { category: 'velocita', name: 'sprint_100m', label: 'Sprint 100m', unit: 'sec' },
            
            // RESISTENZA
            { category: 'resistenza', name: 'cooper_test', label: 'Cooper Test', unit: 'm' },
            { category: 'resistenza', name: 'time_1km', label: 'Tempo 1 Km', unit: 'sec' },
            { category: 'resistenza', name: 'time_5km', label: 'Tempo 5 Km', unit: 'min' },
            { category: 'resistenza', name: 'vo2max', label: 'VO2 Max', unit: 'ml/kg/min' },
            
            // COMPOSIZIONE
            { category: 'composizione', name: 'weight', label: 'Peso', unit: 'kg' },
            { category: 'composizione', name: 'body_fat', label: 'Massa Grassa', unit: '%' },
            { category: 'composizione', name: 'waist_circ', label: 'Girovita', unit: 'cm' },
            
            // AGILITA
            { category: 'agilita', name: 'vertical_jump', label: 'Salto Verticale', unit: 'cm' },
            { category: 'agilita', name: 'lateral_agility', label: 'Agilità Laterale', unit: 'sec' },
            
            // TECNICA
            { category: 'tecnica', name: 'pass_accuracy', label: 'Precisione Passaggi', unit: '%' },
            { category: 'tecnica', name: 'shot_accuracy', label: 'Precisione Tiri', unit: '%' },
        ];

        document.addEventListener('DOMContentLoaded', async () => {
            // Set today's date
            document.getElementById('testDate').valueAsDate = new Date();
            
            await loadAthletes();
            renderAvailableTests();
        });

        async function loadAthletes() {
            try {
                athletes = await supabase.fetch('athletes', '?select=*&order=first_name.asc');
                renderAthletes();
            } catch (error) {
                console.error('Error loading athletes:', error);
                document.getElementById('athleteList').innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-exclamation-triangle"></i>
                        <p>Errore nel caricamento</p>
                    </div>
                `;
            }
        }

        function renderAthletes() {
            if (athletes.length === 0) {
                document.getElementById('athleteList').innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-users"></i>
                        <p>Nessun atleta trovato</p>
                    </div>
                `;
                return;
            }

            document.getElementById('athleteList').innerHTML = athletes.map(a => {
                const initials = `${a.first_name?.[0] || ''}${a.last_name?.[0] || ''}`.toUpperCase();
                const sportInfo = [a.sport, a.role, a.goal].filter(Boolean).join(' • ');
                
                return `
                    <div class="athlete-card" data-id="${a.id}" onclick="selectAthlete('${a.id}')">
                        <div class="athlete-avatar">${initials}</div>
                        <div class="athlete-info">
                            <h4>${a.first_name} ${a.last_name}</h4>
                            <p>${sportInfo || 'Nessuna info'}</p>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function selectAthlete(id) {
            selectedAthlete = athletes.find(a => a.id === id);
            
            // Update UI
            document.querySelectorAll('.athlete-card').forEach(c => c.classList.remove('selected'));
            document.querySelector(`.athlete-card[data-id="${id}"]`).classList.add('selected');
            
            document.getElementById('selectedAthleteName').textContent = 
                `${selectedAthlete.first_name} ${selectedAthlete.last_name}`;
            
            document.getElementById('testForm').classList.add('visible');
            
            // Filter tests based on athlete's sport/goal
            filterTestsForAthlete();
            
            // Load history
            loadTestHistory();
        }

        function filterTestsForAthlete() {
            // Per ora mostra tutti, in futuro filtreremo per sport/goal
            testCatalog = defaultTestCatalog;
            renderAvailableTests();
        }

        function renderAvailableTests() {
            const catalog = testCatalog.length > 0 ? testCatalog : defaultTestCatalog;
            
            // Group by category
            const categories = {};
            catalog.forEach(t => {
                if (!categories[t.category]) categories[t.category] = [];
                categories[t.category].push(t);
            });

            let html = '';
            Object.keys(categories).forEach(cat => {
                html += `<div style="grid-column: 1/-1; font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; color: var(--red); margin-top: 8px;">${cat}</div>`;
                categories[cat].forEach(t => {
                    const isSelected = selectedTests[t.name];
                    html += `
                        <div class="test-chip ${isSelected ? 'selected' : ''}" onclick="toggleTest('${t.name}')">
                            <i class="fas fa-${isSelected ? 'check-circle' : 'circle'}"></i>
                            <div class="test-chip-info">
                                <div class="test-chip-name">${t.label}</div>
                                <div class="test-chip-unit">${t.unit}</div>
                            </div>
                        </div>
                    `;
                });
            });

            document.getElementById('availableTests').innerHTML = html;
        }

        function toggleTest(testName) {
            const catalog = testCatalog.length > 0 ? testCatalog : defaultTestCatalog;
            const test = catalog.find(t => t.name === testName);
            
            if (selectedTests[testName]) {
                delete selectedTests[testName];
            } else {
                selectedTests[testName] = { ...test, value: '' };
            }
            
            renderAvailableTests();
            renderTestValues();
            updateSaveButton();
        }

        function renderTestValues() {
            const tests = Object.values(selectedTests);
            
            if (tests.length === 0) {
                document.getElementById('testValuesGrid').innerHTML = `
                    <div class="empty-state" style="grid-column: 1/-1; padding: 24px;">
                        <p>Seleziona i test da registrare</p>
                    </div>
                `;
                return;
            }

            document.getElementById('testValuesGrid').innerHTML = tests.map(t => `
                <div class="test-value-card">
                    <div class="test-value-header">
                        <span class="test-value-name">${t.label}</span>
                        <button class="test-value-remove" onclick="toggleTest('${t.name}')">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="test-value-input">
                        <input type="number" step="0.01" placeholder="0" 
                               value="${t.value}" 
                               oninput="updateTestValue('${t.name}', this.value)">
                        <span class="test-value-unit">${t.unit}</span>
                    </div>
                </div>
            `).join('');
        }

        function updateTestValue(testName, value) {
            if (selectedTests[testName]) {
                selectedTests[testName].value = value;
            }
            updateSaveButton();
        }

        function updateSaveButton() {
            const tests = Object.values(selectedTests);
            const allFilled = tests.length > 0 && tests.every(t => t.value !== '' && t.value !== null);
            document.getElementById('saveBtn').disabled = !allFilled;
        }

        async function saveTests() {
            if (!selectedAthlete) return;
            
            const btn = document.getElementById('saveBtn');
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Salvando...';
            
            const testDate = document.getElementById('testDate').value;
            const notes = document.getElementById('testNotes').value;
            
            try {
                const tests = Object.values(selectedTests);
                
                for (const test of tests) {
                    await supabase.create('fitness_tests', {
                        athlete_id: selectedAthlete.id,
                        sport: selectedAthlete.sport,
                        role: selectedAthlete.role,
                        goal: selectedAthlete.goal,
                        test_category: test.category,
                        test_name: test.name,
                        test_label: test.label,
                        value: parseFloat(test.value),
                        unit: test.unit,
                        test_date: testDate,
                        notes: notes
                    });
                }
                
                // Show success
                document.getElementById('successToast').classList.add('show');
                setTimeout(() => {
                    document.getElementById('successToast').classList.remove('show');
                }, 3000);
                
                // Reset form
                selectedTests = {};
                renderAvailableTests();
                renderTestValues();
                document.getElementById('testNotes').value = '';
                
                // Reload history
                loadTestHistory();
                
            } catch (error) {
                console.error('Error saving tests:', error);
                alert('Errore durante il salvataggio: ' + error.message);
            }
            
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-save"></i> Salva Test';
        }

        async function loadTestHistory() {
            if (!selectedAthlete) return;
            
            try {
                const tests = await supabase.fetch('fitness_tests', 
                    `?athlete_id=eq.${selectedAthlete.id}&select=*&order=test_date.desc&limit=20`
                );
                
                if (tests.length === 0) {
                    document.getElementById('historySection').style.display = 'none';
                    return;
                }
                
                document.getElementById('historySection').style.display = 'block';
                
                document.getElementById('historyBody').innerHTML = tests.map(t => {
                    const date = new Date(t.test_date);
                    const dateStr = date.toLocaleDateString('it-IT', { 
                        day: 'numeric', month: 'short', year: 'numeric' 
                    });
                    
                    return `
                        <tr>
                            <td>${dateStr}</td>
                            <td>${t.test_label}</td>
                            <td><span class="history-value">${t.value} ${t.unit}</span></td>
                            <td style="color: var(--gray-400)">${t.notes || '-'}</td>
                        </tr>
                    `;
                }).join('');
                
            } catch (error) {
                console.log('Tabella fitness_tests non ancora creata');
                document.getElementById('historySection').style.display = 'none';
            }
        }

        function cancelTest() {
            selectedTests = {};
            renderAvailableTests();
            renderTestValues();
            document.getElementById('testForm').classList.remove('visible');
            document.querySelectorAll('.athlete-card').forEach(c => c.classList.remove('selected'));
            selectedAthlete = null;
            document.getElementById('historySection').style.display = 'none';
        }
    </script>
</body>
</html>
