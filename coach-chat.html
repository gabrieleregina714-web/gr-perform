<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>GR Perform - Chat</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        :root {
            --red: #E63946;
            --black: #000;
            --gray-900: #0A0A0A;
            --gray-800: #111;
            --gray-700: #1A1A1A;
            --gray-600: #222;
            --gray-400: #888;
            --gray-500: #666;
            --white: #FFF;
            --green: #00D26A;
            --blue: #2196F3;

            /* Layout vars for cross-device viewport quirks */
            --app-height: 100vh;
            --bottom-nav-height: 0px;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--black);
            color: var(--white);
            height: 100vh;
            overflow: hidden;
        }

        /* SIDEBAR */
        .sidebar {
            position: fixed;
            left: 0; top: 0;
            width: 72px; height: 100vh;
            background: var(--gray-900);
            border-right: 1px solid var(--gray-600);
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px 0;
            z-index: 100;
        }

        .logo {
            width: 44px; height: 44px;
            background: linear-gradient(135deg, #E63946, #FF6B6B);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 900;
            margin-bottom: 40px;
            cursor: pointer;
            text-decoration: none;
            color: var(--white);
        }

        .nav-item {
            width: 44px; height: 44px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--gray-500);
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.2s;
            text-decoration: none;
            position: relative;
        }

        .nav-item:hover { background: var(--gray-700); color: var(--white); }
        .nav-item.active { background: var(--gray-700); color: var(--white); }
        .nav-item.active::before {
            content: '';
            position: absolute;
            left: 0;
            width: 3px;
            height: 24px;
            background: var(--red);
            border-radius: 0 2px 2px 0;
        }

        .nav-spacer { flex: 1; }

        /* CHAT LAYOUT */
        .chat-container {
            margin-left: 72px;
            height: var(--app-height);
            display: grid;
            grid-template-columns: 1fr;
            background: #0b141a;
        }

        /* CONTACTS LIST */
        .contacts {
            background: var(--gray-900);
            border-right: 1px solid var(--gray-700);
            display: flex;
            flex-direction: column;
        }

        .contacts-header {
            padding: 24px;
            border-bottom: 1px solid var(--gray-700);
        }

        .contacts-header h2 {
            font-size: 26px;
            font-weight: 800;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .contacts-header h2 span {
            background: var(--red);
            font-size: 12px;
            padding: 4px 10px;
            border-radius: 12px;
            font-weight: 600;
        }

        .search-box {
            display: flex;
            align-items: center;
            gap: 10px;
            background: var(--gray-800);
            border: 1px solid var(--gray-600);
            border-radius: 12px;
            padding: 12px 16px;
        }

        .search-box i { color: var(--gray-500); }

        .search-box input {
            background: none;
            border: none;
            color: var(--white);
            font-size: 14px;
            width: 100%;
            outline: none;
        }

        .filters {
            display: flex;
            gap: 8px;
            margin-top: 14px;
        }

        .filter-btn {
            flex: 1;
            padding: 10px 12px;
            border-radius: 10px;
            background: var(--gray-800);
            border: 1px solid var(--gray-600);
            color: var(--gray-400);
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .filter-btn:hover, .filter-btn.active {
            background: var(--white);
            color: var(--black);
            border-color: var(--white);
        }

        .contacts-list {
            flex: 1;
            overflow-y: auto;
        }

        .contact-item {
            display: flex;
            align-items: center;
            gap: 14px;
            padding: 16px 24px;
            cursor: pointer;
            transition: all 0.2s;
            border-left: 3px solid transparent;
            position: relative;
        }

        .contact-item:hover { background: var(--gray-800); }
        .contact-item.active { 
            background: var(--gray-800); 
            border-left-color: var(--red);
        }

        .contact-avatar {
            width: 50px; height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #E63946, #FF6B6B);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 16px;
            position: relative;
            flex-shrink: 0;
        }

        .contact-avatar.online::after {
            content: '';
            position: absolute;
            bottom: 2px; right: 2px;
            width: 12px; height: 12px;
            background: var(--green);
            border-radius: 50%;
            border: 2px solid var(--gray-900);
        }

        .contact-info { flex: 1; min-width: 0; }
        .contact-name { font-weight: 600; font-size: 15px; }
        .contact-preview { 
            font-size: 13px; 
            color: var(--gray-400); 
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-top: 4px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .contact-preview i { font-size: 11px; }

        .contact-meta { text-align: right; }
        .contact-time { font-size: 11px; color: var(--gray-500); }

        .contact-unread {
            min-width: 22px; height: 22px;
            background: var(--red);
            border-radius: 11px;
            font-size: 11px;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-top: 6px;
            margin-left: auto;
            padding: 0 6px;
        }

        /* CHAT AREA */
        .chat-area {
            display: flex;
            flex-direction: column;
            background: #0b141a;
        }

        .chat-header {
            padding: 10px 12px;
            border-bottom: 1px solid rgba(255,255,255,0.06);
            display: flex;
            align-items: center;
            gap: 12px;
            background: #111b21;
        }

        .mobile-back-btn {
            display: none;
            width: 40px;
            height: 40px;
            border-radius: 12px;
            background: var(--gray-800);
            border: none;
            color: var(--white);
            cursor: pointer;
            align-items: center;
            justify-content: center;
        }

        .chat-header-avatar {
            width: 38px; height: 38px;
            border-radius: 50%;
            background: linear-gradient(135deg, #E63946, #FF6B6B);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 13px;
        }

        .chat-header-info { flex: 1; }
        .chat-header-info h3 { font-size: 15px; font-weight: 800; line-height: 1.15; }
        .chat-header-info p { font-size: 11px; color: var(--gray-400); display: flex; align-items: center; gap: 6px; margin-top: 2px; }
        .chat-header-info p i { font-size: 8px; }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--gray-500);
            display: inline-block;
        }

        .status-dot.offline { background: var(--red); }

        .chat-header-actions {
            display: flex;
            gap: 6px;
            align-items: center;
        }

        .header-action {
            width: 34px; height: 34px;
            border-radius: 12px;
            background: var(--gray-800);
            border: none;
            color: var(--gray-400);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .header-action i { line-height: 1; }

        .header-action:hover { background: var(--gray-700); color: var(--white); }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 14px 12px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            background:
                radial-gradient(circle at 20% 20%, rgba(255,255,255,0.03), transparent 40%),
                radial-gradient(circle at 80% 30%, rgba(255,255,255,0.02), transparent 45%),
                #0b141a;
        }

            /* Keep input always visible */
            .chat-area {
                display: flex;
                flex-direction: column;
                min-height: 0;
            }

        /* DATE SEPARATOR */
        .date-separator {
            text-align: center;
            margin: 20px 0;
        }

        .date-separator span {
            background: var(--gray-800);
            padding: 6px 16px;
            border-radius: 20px;
            font-size: 12px;
            color: var(--gray-400);
        }

        /* MESSAGES */
        .message-wrapper {
            display: flex;
            flex-direction: column;
            max-width: 70%;
        }

        .message-wrapper.sent {
            align-self: flex-end;
            align-items: flex-end;
        }

        .message-wrapper.received {
            align-self: flex-start;
            align-items: flex-start;
        }

        .message {
            padding: 10px 12px;
            border-radius: 14px;
            font-size: 14px;
            line-height: 1.45;
            position: relative;
        }

        .message.received {
            background: #202c33;
            border-bottom-left-radius: 6px;
        }

        .message.sent {
            background: var(--gray-700);
            border-bottom-right-radius: 6px;
        }

        .message-footer {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-top: 6px;
            font-size: 11px;
            color: var(--gray-500);
        }

        .message-wrapper.sent .message-footer {
            color: rgba(255,255,255,0.5);
        }

        /* READ RECEIPTS */
        .read-receipt {
            display: flex;
            align-items: center;
        }

        .read-receipt i {
            font-size: 12px;
        }

        .read-receipt.sent { color: var(--gray-500); }
        .read-receipt.delivered { color: var(--gray-400); }
        .read-receipt.read { color: var(--blue); }

        /* MEDIA MESSAGES */
        .message-media {
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 8px;
            max-width: 280px;
        }

        .message-media img {
            width: 100%;
            display: block;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .message-media img:hover { transform: scale(1.02); }

        .message-media video {
            width: 100%;
            display: block;
            border-radius: 12px;
        }

        .message-file {
            display: flex;
            align-items: center;
            gap: 12px;
            background: var(--gray-700);
            padding: 12px 16px;
            border-radius: 12px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .message-file:hover { background: var(--gray-600); }

        .file-icon {
            width: 44px; height: 44px;
            border-radius: 10px;
            background: var(--red);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }

        .file-icon.pdf { background: #E53935; }
        .file-icon.doc { background: #1E88E5; }
        .file-icon.xls { background: #43A047; }

        .file-info { flex: 1; }
        .file-name { font-size: 13px; font-weight: 600; }
        .file-size { font-size: 11px; color: var(--gray-400); margin-top: 2px; }

        /* VOICE MESSAGE */
        .voice-message {
            display: flex;
            align-items: center;
            gap: 12px;
            min-width: 200px;
        }

        .voice-play {
            width: 36px; height: 36px;
            border-radius: 50%;
            background: var(--white);
            border: none;
            color: var(--red);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .voice-waveform {
            flex: 1;
            height: 30px;
            display: flex;
            align-items: center;
            gap: 2px;
        }

        .voice-bar {
            width: 3px;
            background: rgba(255,255,255,0.4);
            border-radius: 2px;
        }

        .voice-duration { font-size: 12px; color: rgba(255,255,255,0.6); }

        /* CHAT INPUT */
        .chat-input-area {
            padding: 8px 10px;
            border-top: 1px solid rgba(255,255,255,0.06);
            background: #111b21;
            position: sticky;
            bottom: 0;
            z-index: 10;
            padding-bottom: calc(8px + env(safe-area-inset-bottom));
        }

        /* MEDIA PREVIEW */
        .media-preview {
            display: none;
            margin-bottom: 16px;
            background: var(--gray-800);
            border-radius: 12px;
            padding: 12px;
            position: relative;
        }

        .media-preview.show { display: flex; gap: 12px; flex-wrap: wrap; }

        .preview-item {
            position: relative;
            width: 80px; height: 80px;
            border-radius: 10px;
            overflow: hidden;
        }

        .preview-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .preview-item .remove-preview {
            position: absolute;
            top: 4px; right: 4px;
            width: 22px; height: 22px;
            border-radius: 50%;
            background: rgba(0,0,0,0.7);
            border: none;
            color: var(--white);
            cursor: pointer;
            font-size: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .preview-file {
            display: flex;
            align-items: center;
            gap: 10px;
            background: var(--gray-700);
            padding: 10px 14px;
            border-radius: 10px;
        }

        .preview-file i { font-size: 24px; color: var(--red); }
        .preview-file span { font-size: 13px; }

        .chat-input-box {
            display: flex;
            align-items: flex-end;
            gap: 10px;
        }

        /* MEDIA HISTORY MODAL */
        .media-modal {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.75);
            display: none;
            align-items: flex-end;
            justify-content: center;
            z-index: 1200;
        }

        .media-modal.show { display: flex; }

        .media-panel {
            width: min(720px, 100%);
            max-height: 85vh;
            background: #0b141a;
            border: 1px solid rgba(255,255,255,0.08);
            border-radius: 18px 18px 0 0;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .media-panel-header {
            padding: 14px 16px;
            background: #111b21;
            border-bottom: 1px solid rgba(255,255,255,0.06);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .media-panel-title {
            font-size: 16px;
            font-weight: 800;
            flex: 1;
        }

        .media-filters {
            padding: 12px 16px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            border-bottom: 1px solid rgba(255,255,255,0.06);
        }

        .media-filter {
            background: rgba(255,255,255,0.06);
            border: 1px solid rgba(255,255,255,0.10);
            color: var(--white);
            border-radius: 12px;
            padding: 10px 12px;
            font-size: 13px;
            outline: none;
        }

        .media-list {
            padding: 12px 16px 18px;
            overflow-y: auto;
        }

        .media-day {
            margin-top: 14px;
            margin-bottom: 8px;
            font-size: 12px;
            color: var(--gray-400);
            text-transform: uppercase;
            letter-spacing: 0.08em;
        }

        .media-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 10px;
            border-radius: 12px;
            cursor: pointer;
            border: 1px solid rgba(255,255,255,0.06);
            background: rgba(255,255,255,0.03);
        }

        .media-item + .media-item { margin-top: 10px; }

        .media-thumb {
            width: 54px;
            height: 54px;
            border-radius: 12px;
            background: rgba(255,255,255,0.06);
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .media-thumb img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .media-meta {
            flex: 1;
            min-width: 0;
        }

        .media-name {
            font-size: 14px;
            font-weight: 700;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .media-sub {
            margin-top: 2px;
            font-size: 12px;
            color: var(--gray-400);
        }

        .input-actions {
            display: flex;
            gap: 4px;
            align-items: center;
        }

        .input-action {
            width: 32px; height: 32px;
            border-radius: 999px;
            background: #202c33;
            border: none;
            color: var(--gray-400);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            position: relative;
        }

        .input-action i { line-height: 1; font-size: 14px; }

        .input-action:hover { background: rgba(255,255,255,0.10); color: var(--white); }

        .input-action input[type="file"] {
            position: absolute;
            width: 100%;
            height: 100%;
            opacity: 0;
            cursor: pointer;
        }

        .message-input-wrapper {
            flex: 1;
            background: var(--gray-800);
            border: 1px solid var(--gray-600);
            border-radius: 999px;
            display: flex;
            align-items: flex-end;
            padding: 3px 5px 3px 12px;
            transition: border-color 0.2s;
        }

        .message-input-wrapper:focus-within { border-color: var(--red); }

        .message-input {
            flex: 1;
            background: none;
            border: none;
            color: var(--white);
            font-size: 13px;
            outline: none;
            resize: none;
            max-height: 120px;
            padding: 7px 0;
            font-family: inherit;
            line-height: 1.25;
        }

        .send-btn {
            width: 30px; height: 30px;
            border-radius: 50%;
            background: var(--red);
            border: none;
            color: var(--white);
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .send-btn i { line-height: 1; }

        .send-btn:hover { transform: scale(1.1); }
        .send-btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }

        /* EMPTY STATE */
        .empty-chat {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: var(--gray-500);
        }

        .empty-chat i { font-size: 80px; margin-bottom: 24px; opacity: 0.2; }
        .empty-chat h3 { font-size: 20px; color: var(--gray-400); margin-bottom: 8px; }
        .empty-chat p { font-size: 14px; }

        /* TYPING INDICATOR */
        .typing-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px 18px;
            background: var(--gray-800);
            border-radius: 18px;
            align-self: flex-start;
            margin-bottom: 16px;
        }

        .typing-dots {
            display: flex;
            gap: 4px;
        }

        .typing-dot {
            width: 8px; height: 8px;
            border-radius: 50%;
            background: var(--gray-500);
            animation: typingBounce 1.4s infinite ease-in-out;
        }

        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }

        @keyframes typingBounce {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-6px); }
        }

        /* IMAGE LIGHTBOX */
        .lightbox {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.95);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .lightbox.show { display: flex; }

        .lightbox img {
            max-width: 90%;
            max-height: 90%;
            border-radius: 8px;
        }

        .lightbox-close {
            position: absolute;
            top: 20px; right: 20px;
            width: 50px; height: 50px;
            border-radius: 50%;
            background: var(--gray-800);
            border: none;
            color: var(--white);
            font-size: 24px;
            cursor: pointer;
        }

        /* Mobile back button in chat header */
        .mobile-back-btn {
            display: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--gray-700);
            border: none;
            color: var(--white);
            font-size: 16px;
            cursor: pointer;
            align-items: center;
            justify-content: center;
            margin-right: 12px;
            flex-shrink: 0;
        }
        
        @media (max-width: 900px) {
            .mobile-back-btn { display: flex; }
        }

        /* RESPONSIVE */
        @media (max-width: 900px) {
            .chat-container { grid-template-columns: 1fr; }
            .contacts { display: none; }
            .contacts.mobile-show {
                display: flex;
                position: fixed;
                inset: 0;
                bottom: 70px;
                z-index: 50;
                background: var(--gray-900);
            }
        }

        @media (max-width: 768px) {
            .sidebar { display: none; }
            :root { --bottom-nav-height: 0px; }
            .chat-container {
                margin-left: 0;
                margin-bottom: 0;
                height: var(--app-height);
            }
        }

        @media (max-width: 900px) {
            .mobile-back-btn { display: flex; }
        }
    </style>
</head>
<body>
    <nav class="sidebar">
        <a href="coach-dashboard.html" class="logo" style="overflow:hidden;border-radius:12px;background:none;">
            <img src="https://cdn.shopify.com/s/files/1/0969/1801/2243/files/Black_White_Bold_Modern_Clothing_Brand_Logo_97389bbf-665b-4465-82ec-d71a0fa4b35e.png?v=1758700090" alt="GR" style="width:100%;height:100%;object-fit:cover;">
        </a>
        <a href="coach-dashboard.html" class="nav-item"><i class="fas fa-th-large"></i></a>
        <a href="coach-clients.html" class="nav-item"><i class="fas fa-users"></i></a>
        <a href="coach-generate.html" class="nav-item"><i class="fas fa-bolt"></i></a>
        <div class="nav-spacer"></div>
        <a href="#" onclick="coachLogout(event)" class="nav-item"><i class="fas fa-sign-out-alt"></i></a>
    </nav>

    <div class="chat-container">
        <div class="chat-area" id="chat-area">
            <div class="empty-chat">
                <i class="fas fa-comments"></i>
                <h3>Apri una chat</h3>
                <p>Vai da un profilo atleta e tocca Chat</p>
                <a href="coach-clients.html" style="margin-top:16px;display:inline-block;padding:10px 16px;background:var(--red);color:white;border-radius:12px;text-decoration:none;font-weight:700;">Vai a Clienti</a>
            </div>
        </div>
    </div>

    <!-- LIGHTBOX -->
    <div class="lightbox" id="lightbox" onclick="closeLightbox()">
        <button class="lightbox-close"><i class="fas fa-times"></i></button>
        <img id="lightbox-img" src="">
    </div>

    <!-- MEDIA HISTORY -->
    <div class="media-modal" id="media-modal" onclick="closeMediaHistory(event)">
        <div class="media-panel" onclick="event.stopPropagation()">
            <div class="media-panel-header">
                <div class="media-panel-title">Cronologia multimediale</div>
                <button class="header-action" onclick="closeMediaHistory()" title="Chiudi"><i class="fas fa-times"></i></button>
            </div>
            <div class="media-filters">
                <select class="media-filter" id="media-filter-type" onchange="renderMediaHistory()">
                    <option value="all">Tutto</option>
                    <option value="image">Foto</option>
                    <option value="file">File</option>
                    <option value="video">Video</option>
                </select>
                <input class="media-filter" type="month" id="media-filter-month" onchange="renderMediaHistory()" />
                <input class="media-filter" type="date" id="media-filter-date" onchange="renderMediaHistory()" />
                <button class="header-action" onclick="clearMediaFilters()" title="Reset"><i class="fas fa-rotate-left"></i></button>
            </div>
            <div class="media-list" id="media-list"></div>
        </div>
    </div>

    <script src="js/supabase-client.js"></script>
    <script>
        // Check if coach is logged in
        if (localStorage.getItem('gr_coach_logged_in') !== 'true') {
            window.location.href = 'coach-login.html';
        }

        // Logout function
        function coachLogout(event) {
            if (event) event.preventDefault();
            localStorage.removeItem('gr_coach_logged_in');
            localStorage.removeItem('gr_coach_email');
            localStorage.removeItem('gr_coach_name');
            localStorage.removeItem('gr_coach_last_active');
            window.location.replace('coach-login.html');
        }
        let selectedAthleteId = null;
        let pendingMedia = [];
        let cameFromProfile = false;
        let currentAthlete = null;
        let currentMessages = [];

        function showMissing(message = 'Apri la chat dal profilo di un atleta') {
            selectedAthleteId = null;
            currentAthlete = null;
            document.getElementById('chat-area').innerHTML = `
                <div class="empty-chat">
                    <i class="fas fa-comments"></i>
                    <h3>${message}</h3>
                    <p>Vai su Clienti, apri un profilo e premi Chat</p>
                    <a href="coach-clients.html" style="margin-top:16px;display:inline-block;padding:10px 16px;background:var(--red);color:var(--white);border-radius:999px;text-decoration:none;font-weight:800;">Vai a Clienti</a>
                </div>
            `;
        }

        function goBackFromChat() {
            window.location.href = 'coach-clients.html';
        }

        document.addEventListener('DOMContentLoaded', async () => {
            // Keep CSS viewport height stable across iOS/Android address bar + keyboard
            const setAppHeight = () => {
                const h = (window.visualViewport && window.visualViewport.height) ? window.visualViewport.height : window.innerHeight;
                document.documentElement.style.setProperty('--app-height', `${Math.round(h)}px`);
            };
            setAppHeight();
            window.addEventListener('resize', setAppHeight);
            window.addEventListener('orientationchange', setAppHeight);
            if (window.visualViewport) {
                window.visualViewport.addEventListener('resize', setAppHeight);
                window.visualViewport.addEventListener('scroll', setAppHeight);
            }

            const urlParams = new URLSearchParams(window.location.search);
            let athleteId = urlParams.get('athlete');

            // Mobile sometimes opens this page from nav without params.
            // Fallback to last opened athlete.
            if (!athleteId) {
                try { athleteId = localStorage.getItem('gr_last_chat_athlete_id'); } catch (_) {}
            }

            if (!athleteId) {
                showMissing('Nessun atleta selezionato');
                return;
            }

            cameFromProfile = true;
            try { localStorage.setItem('gr_last_chat_athlete_id', String(athleteId)); } catch (_) {}
            if (!urlParams.get('athlete')) {
                const newUrl = `${window.location.pathname}?athlete=${encodeURIComponent(String(athleteId))}`;
                window.history.replaceState({}, '', newUrl);
            }
            await selectAthlete(String(athleteId));
        });

        function formatTime(dateStr) {
            const date = new Date(dateStr);
            const now = new Date();
            const diff = now - date;
            
            if (diff < 86400000 && date.getDate() === now.getDate()) {
                return date.toLocaleTimeString('it-IT', { hour: '2-digit', minute: '2-digit' });
            } else if (diff < 172800000) {
                return 'Ieri';
            } else {
                return date.toLocaleDateString('it-IT', { day: '2-digit', month: '2-digit' });
            }
        }

        async function selectAthlete(id) {
            id = String(id);
            selectedAthleteId = id;
            try { localStorage.setItem('gr_last_chat_athlete_id', id); } catch (_) {}
            let athlete = currentAthlete && String(currentAthlete.id) === id ? currentAthlete : null;
            if (!athlete) {
                const fetched = await supabase.fetch('athletes', `?id=eq.${id}&select=*`);
                if (fetched && fetched[0]) {
                    athlete = { ...fetched[0], id: String(fetched[0].id) };
                    currentAthlete = athlete;
                } else {
                    showMissing('Atleta non trovato');
                    return;
                }
            }
            
            // Mark as read
            await fetch(`https://unkzjnlrorluzfahmize.supabase.co/rest/v1/chat_messages?athlete_id=eq.${id}&sender=eq.athlete&read=eq.false`, {
                method: 'PATCH',
                headers: {
                    'apikey': 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVua3pqbmxyb3JsdXpmYWhtaXplIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU3OTQ3MTIsImV4cCI6MjA4MTM3MDcxMn0.c1utLN0YO2k6K-8cFokp7LaTD2ND6Mb0l2BxeFW4oxM',
                    'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVua3pqbmxyb3JsdXpmYWhtaXplIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU3OTQ3MTIsImV4cCI6MjA4MTM3MDcxMn0.c1utLN0YO2k6K-8cFokp7LaTD2ND6Mb0l2BxeFW4oxM',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ read: true })
            });

            const messages = await supabase.fetch('chat_messages', 
                `?athlete_id=eq.${id}&select=*&order=created_at.asc`
            );

            currentMessages = Array.isArray(messages) ? messages : [];

            const initials = (athlete.first_name?.[0] || '') + (athlete.last_name?.[0] || '');
            
            document.getElementById('chat-area').innerHTML = `
                <div class="chat-header">
                    <button class="mobile-back-btn" onclick="goBackFromChat()"><i class="fas fa-arrow-left"></i></button>
                    <div class="chat-header-avatar">${initials}</div>
                    <div class="chat-header-info">
                        <h3>${athlete.first_name} ${athlete.last_name}</h3>
                        <p id="connection-status"><span class="status-dot" id="connection-dot"></span> <span id="connection-text">Online</span></p>
                    </div>
                    <div class="chat-header-actions">
                        <button class="header-action" onclick="location.href='athlete-profile.html?id=${id}'" title="Profilo"><i class="fas fa-user"></i></button>
                        <button class="header-action" onclick="callAthlete('${athlete.phone || ''}')" title="Chiama"><i class="fas fa-phone"></i></button>
                        <button class="header-action" onclick="openMediaHistory()" title="Media"><i class="fas fa-photo-film"></i></button>
                    </div>
                </div>
                <div class="chat-messages" id="messages">
                    ${renderMessages(messages)}
                </div>
                <div class="chat-input-area">
                    <div class="media-preview" id="media-preview"></div>
                    <div class="chat-input-box">
                        <div class="input-actions">
                            <button class="input-action" title="Invia foto">
                                <i class="fas fa-camera"></i>
                                <input type="file" accept="image/*" multiple onchange="handleImageSelect(event)">
                            </button>
                        </div>

                        <div class="message-input-wrapper">
                            <textarea id="message-input" class="message-input" placeholder="Scrivi un messaggio" oninput="autoResize(this)" onkeypress="handleKeyPress(event)"></textarea>
                            <button class="send-btn" onclick="sendMessage()" title="Invia"><i class="fas fa-paper-plane"></i></button>
                        </div>
                    </div>
            `;

                updateConnectionStatus();

            document.getElementById('messages').scrollTop = document.getElementById('messages').scrollHeight;
        }

        function updateConnectionStatus() {
            const dot = document.getElementById('connection-dot');
            const text = document.getElementById('connection-text');
            if (!dot || !text) return;

            const isOnline = navigator.onLine;
            text.textContent = isOnline ? 'Online' : 'Offline';
            dot.classList.toggle('offline', !isOnline);
        }

        window.addEventListener('online', updateConnectionStatus);
        window.addEventListener('offline', updateConnectionStatus);

        function openMediaHistory() {
            if (!selectedAthleteId) return;
            document.getElementById('media-modal').classList.add('show');
            renderMediaHistory();
        }

        function closeMediaHistory(event) {
            if (event && event.target && event.target.closest && event.target.closest('.media-panel')) return;
            const modal = document.getElementById('media-modal');
            if (modal) modal.classList.remove('show');
        }

        function clearMediaFilters() {
            const month = document.getElementById('media-filter-month');
            const date = document.getElementById('media-filter-date');
            const type = document.getElementById('media-filter-type');
            if (month) month.value = '';
            if (date) date.value = '';
            if (type) type.value = 'all';
            renderMediaHistory();
        }

        function renderMediaHistory() {
            const list = document.getElementById('media-list');
            if (!list) return;

            const type = (document.getElementById('media-filter-type')?.value || 'all').trim();
            const month = (document.getElementById('media-filter-month')?.value || '').trim();
            const date = (document.getElementById('media-filter-date')?.value || '').trim();

            // Support current schema (image_url) and optional future schema (media_type/media_url/file_name)
            const media = (currentMessages || []).filter(m => {
                if (m.image_url) return true;
                if (m.media_url && m.media_type) return true;
                return false;
            });

            const filtered = media.filter(m => {
                const d = new Date(m.created_at);

                // Type filter
                const msgType = m.image_url ? 'image' : (m.media_type || 'file');
                if (type !== 'all' && msgType !== type) return false;

                if (date) {
                    const wanted = new Date(date);
                    return d.getFullYear() === wanted.getFullYear() && d.getMonth() === wanted.getMonth() && d.getDate() === wanted.getDate();
                }
                if (month) {
                    const [y, mo] = month.split('-').map(x => parseInt(x, 10));
                    return d.getFullYear() === y && (d.getMonth() + 1) === mo;
                }
                return true;
            });

            if (!filtered.length) {
                list.innerHTML = `<div style="text-align:center;color:var(--gray-500);padding:26px 10px;">Nessun media trovato</div>`;
                return;
            }

            // Group by day
            const groups = new Map();
            for (const m of filtered) {
                const d = new Date(m.created_at);
                const key = d.toISOString().slice(0, 10); // YYYY-MM-DD
                if (!groups.has(key)) groups.set(key, []);
                groups.get(key).push(m);
            }

            const sortedKeys = Array.from(groups.keys()).sort((a, b) => (a < b ? 1 : -1));
            let html = '';
            for (const key of sortedKeys) {
                const d = new Date(key + 'T00:00:00');
                const label = d.toLocaleDateString('it-IT', { weekday: 'long', day: '2-digit', month: 'long' });
                html += `<div class="media-day">${label}</div>`;
                for (const m of groups.get(key)) {
                    const t = new Date(m.created_at).toLocaleTimeString('it-IT', { hour: '2-digit', minute: '2-digit' });
                    const isImage = !!m.image_url || m.media_type === 'image';
                    const url = m.image_url || m.media_url;
                    const safeUrl = String(url || '').replace(/'/g, "\\'");

                    const typeLabel = isImage ? 'Foto' : (m.media_type === 'video' ? 'Video' : 'File');
                    const name = m.file_name || (isImage ? 'Immagine' : typeLabel);

                    const thumb = isImage
                        ? `<img src="${url}" alt="">`
                        : `<i class="fas fa-${m.media_type === 'video' ? 'video' : 'file'}" style="color:var(--gray-400);"></i>`;

                    const onClick = isImage
                        ? `openLightbox('${safeUrl}')`
                        : `window.open('${safeUrl}')`;

                    html += `
                        <div class="media-item" onclick="${onClick}">
                            <div class="media-thumb">${thumb}</div>
                            <div class="media-meta">
                                <div class="media-name">${name}</div>
                                <div class="media-sub">${typeLabel} â€¢ ${t}</div>
                            </div>
                            <i class="fas fa-chevron-right" style="color:var(--gray-500);"></i>
                        </div>
                    `;
                }
            }

            list.innerHTML = html;
        }

        function renderMessages(messages) {
            let html = '';
            let lastDate = '';

            messages.forEach(m => {
                const msgDate = new Date(m.created_at).toLocaleDateString('it-IT', { day: 'numeric', month: 'long' });
                if (msgDate !== lastDate) {
                    html += `<div class="date-separator"><span>${msgDate}</span></div>`;
                    lastDate = msgDate;
                }

                const isSent = m.sender === 'coach';
                const time = new Date(m.created_at).toLocaleTimeString('it-IT', { hour: '2-digit', minute: '2-digit' });

                let mediaHtml = '';
                if (m.image_url) {
                    const safeUrl = String(m.image_url).replace(/'/g, "\\'");
                    mediaHtml = `<div class="message-media"><img src="${m.image_url}" onclick="openLightbox('${safeUrl}')"></div>`;
                }

                html += `
                    <div class="message-wrapper ${isSent ? 'sent' : 'received'}">
                        <div class="message ${isSent ? 'sent' : 'received'}">
                            ${mediaHtml}
                            ${m.message ? m.message : ''}
                        </div>
                        <div class="message-footer">
                            <span>${time}</span>
                            ${isSent ? `
                                <span class="read-receipt ${m.read ? 'read' : 'sent'}">
                                    <i class="fas fa-check${m.read ? '-double' : ''}"></i>
                                </span>
                            ` : ''}
                        </div>
                    </div>
                `;
            });

            return html || '<div style="text-align: center; color: var(--gray-500); padding: 40px;">Inizia la conversazione</div>';
        }

        function handleKeyPress(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        }

        function autoResize(el) {
            el.style.height = 'auto';
            el.style.height = Math.min(el.scrollHeight, 120) + 'px';
        }

        function handleImageSelect(e) {
            const files = Array.from(e.target.files);
            files.forEach(async (file) => {
                try {
                    const compressed = await compressImageToDataUrl(file);
                    pendingMedia.push({ type: 'image', url: compressed, file });
                    updateMediaPreview();
                } catch (err) {
                    console.error('Image compress failed:', err);
                    const reader = new FileReader();
                    reader.onload = (ev) => {
                        pendingMedia.push({ type: 'image', url: ev.target.result, file });
                        updateMediaPreview();
                    };
                    reader.readAsDataURL(file);
                }
            });
        }

        function compressImageToDataUrl(file) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                const url = URL.createObjectURL(file);

                img.onload = () => {
                    try {
                        const maxDim = 1280;
                        const scale = Math.min(1, maxDim / Math.max(img.width, img.height));
                        const w = Math.max(1, Math.round(img.width * scale));
                        const h = Math.max(1, Math.round(img.height * scale));

                        const canvas = document.createElement('canvas');
                        canvas.width = w;
                        canvas.height = h;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, w, h);

                        const dataUrl = canvas.toDataURL('image/jpeg', 0.75);
                        URL.revokeObjectURL(url);
                        resolve(dataUrl);
                    } catch (e) {
                        URL.revokeObjectURL(url);
                        reject(e);
                    }
                };

                img.onerror = (e) => {
                    URL.revokeObjectURL(url);
                    reject(e);
                };

                img.src = url;
            });
        }

        function handleVideoSelect(e) {
            const file = e.target.files[0];
            if (file) {
                const url = URL.createObjectURL(file);
                pendingMedia.push({ type: 'video', url, file });
                updateMediaPreview();
            }
        }

        function handleFileSelect(e) {
            const file = e.target.files[0];
            if (file) {
                pendingMedia.push({ type: 'file', name: file.name, file });
                updateMediaPreview();
            }
        }

        function updateMediaPreview() {
            const preview = document.getElementById('media-preview');
            if (!preview) return;
            if (!pendingMedia.length) {
                preview.classList.remove('show');
                preview.innerHTML = '';
                return;
            }

            preview.classList.add('show');
            preview.innerHTML = pendingMedia.map((m, i) => {
                if (m.type === 'image') {
                    return `
                        <div class="preview-item">
                            <img src="${m.url}">
                            <button class="remove-preview" onclick="removePendingMedia(${i})"><i class="fas fa-times"></i></button>
                        </div>
                    `;
                } else if (m.type === 'video') {
                    return `
                        <div class="preview-item" style="background: var(--gray-700); display: flex; align-items: center; justify-content: center;">
                            <i class="fas fa-video" style="font-size: 24px;"></i>
                            <button class="remove-preview" onclick="removePendingMedia(${i})"><i class="fas fa-times"></i></button>
                        </div>
                    `;
                } else {
                    return `
                        <div class="preview-file">
                            <i class="fas fa-file-pdf"></i>
                            <span>${m.name}</span>
                            <button class="remove-preview" onclick="removePendingMedia(${i})" style="position: static; margin-left: auto;"><i class="fas fa-times"></i></button>
                        </div>
                    `;
                }
            }).join('');
        }

        function removePendingMedia(index) {
            pendingMedia.splice(index, 1);
            updateMediaPreview();
        }

        async function sendMessage() {
            const input = document.getElementById('message-input');
            const message = input.value.trim();
            
            if (!message && !pendingMedia.length) return;
            if (!selectedAthleteId) return;

            input.value = '';
            input.style.height = 'auto';

            const errors = [];

            // Send text
            if (message) {
                const res = await supabase.insert('chat_messages', {
                    athlete_id: selectedAthleteId,
                    sender: 'coach',
                    message: message,
                    read: false
                });
                if (res?.error) errors.push(res.message || 'Invio messaggio fallito');
            }

            // Send images (schema: image_url)
            for (const media of pendingMedia) {
                if (media.type !== 'image') continue;
                const res = await supabase.insert('chat_messages', {
                    athlete_id: selectedAthleteId,
                    sender: 'coach',
                    message: '',
                    image_url: media.url,
                    read: false
                });
                if (res?.error) errors.push(res.message || 'Invio immagine fallito');
            }

            pendingMedia = [];
            updateMediaPreview();
            selectAthlete(selectedAthleteId);

            if (errors.length) {
                alert(errors[0]);
            }
        }

        function openLightbox(url) {
            document.getElementById('lightbox-img').src = url;
            document.getElementById('lightbox').classList.add('show');
        }

        function closeLightbox() {
            document.getElementById('lightbox').classList.remove('show');
        }

        // Call athlete function
        function callAthlete(phone) {
            if (phone && phone.trim()) {
                // Open phone dialer
                window.location.href = `tel:${phone}`;
            } else {
                alert('Numero di telefono non disponibile per questo atleta');
            }
        }

        // Poll for new messages
        setInterval(async () => {
            if (selectedAthleteId) {
                const messages = await supabase.fetch('chat_messages', 
                    `?athlete_id=eq.${selectedAthleteId}&select=*&order=created_at.asc`
                );
                const el = document.getElementById('messages');
                if (el) el.innerHTML = renderMessages(messages);
                currentMessages = Array.isArray(messages) ? messages : [];
                // Keep media modal in sync if open
                if (document.getElementById('media-modal')?.classList.contains('show')) {
                    renderMediaHistory();
                }
            }
        }, 5000);
    </script>
</body>
</html>
