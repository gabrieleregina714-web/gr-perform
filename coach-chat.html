<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GR Perform - Chat</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        :root {
            --red: #E63946;
            --black: #000;
            --gray-900: #0A0A0A;
            --gray-800: #111;
            --gray-700: #1A1A1A;
            --gray-600: #222;
            --gray-400: #888;
            --gray-500: #666;
            --white: #FFF;
            --green: #00D26A;
            --blue: #2196F3;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--black);
            color: var(--white);
            height: 100vh;
            overflow: hidden;
        }

        /* SIDEBAR */
        .sidebar {
            position: fixed;
            left: 0; top: 0;
            width: 72px; height: 100vh;
            background: var(--gray-900);
            border-right: 1px solid var(--gray-600);
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px 0;
            z-index: 100;
        }

        .logo {
            width: 44px; height: 44px;
            background: linear-gradient(135deg, #E63946, #FF6B6B);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 900;
            margin-bottom: 40px;
            cursor: pointer;
            text-decoration: none;
            color: var(--white);
        }

        .nav-item {
            width: 44px; height: 44px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--gray-500);
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.2s;
            text-decoration: none;
            position: relative;
        }

        .nav-item:hover { background: var(--gray-700); color: var(--white); }
        .nav-item.active { background: var(--gray-700); color: var(--white); }
        .nav-item.active::before {
            content: '';
            position: absolute;
            left: 0;
            width: 3px;
            height: 24px;
            background: var(--red);
            border-radius: 0 2px 2px 0;
        }

        .nav-spacer { flex: 1; }

        /* CHAT LAYOUT */
        .chat-container {
            margin-left: 72px;
            height: 100vh;
            display: grid;
            grid-template-columns: 340px 1fr;
        }

        /* CONTACTS LIST */
        .contacts {
            background: var(--gray-900);
            border-right: 1px solid var(--gray-700);
            display: flex;
            flex-direction: column;
        }

        .contacts-header {
            padding: 24px;
            border-bottom: 1px solid var(--gray-700);
        }

        .contacts-header h2 {
            font-size: 26px;
            font-weight: 800;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .contacts-header h2 span {
            background: var(--red);
            font-size: 12px;
            padding: 4px 10px;
            border-radius: 12px;
            font-weight: 600;
        }

        .search-box {
            display: flex;
            align-items: center;
            gap: 10px;
            background: var(--gray-800);
            border: 1px solid var(--gray-600);
            border-radius: 12px;
            padding: 12px 16px;
        }

        .search-box i { color: var(--gray-500); }

        .search-box input {
            background: none;
            border: none;
            color: var(--white);
            font-size: 14px;
            width: 100%;
            outline: none;
        }

        .filters {
            display: flex;
            gap: 8px;
            margin-top: 14px;
        }

        .filter-btn {
            flex: 1;
            padding: 10px 12px;
            border-radius: 10px;
            background: var(--gray-800);
            border: 1px solid var(--gray-600);
            color: var(--gray-400);
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .filter-btn:hover, .filter-btn.active {
            background: var(--white);
            color: var(--black);
            border-color: var(--white);
        }

        .contacts-list {
            flex: 1;
            overflow-y: auto;
        }

        .contact-item {
            display: flex;
            align-items: center;
            gap: 14px;
            padding: 16px 24px;
            cursor: pointer;
            transition: all 0.2s;
            border-left: 3px solid transparent;
            position: relative;
        }

        .contact-item:hover { background: var(--gray-800); }
        .contact-item.active { 
            background: var(--gray-800); 
            border-left-color: var(--red);
        }

        .contact-avatar {
            width: 50px; height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #E63946, #FF6B6B);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 16px;
            position: relative;
            flex-shrink: 0;
        }

        .contact-avatar.online::after {
            content: '';
            position: absolute;
            bottom: 2px; right: 2px;
            width: 12px; height: 12px;
            background: var(--green);
            border-radius: 50%;
            border: 2px solid var(--gray-900);
        }

        .contact-info { flex: 1; min-width: 0; }
        .contact-name { font-weight: 600; font-size: 15px; }
        .contact-preview { 
            font-size: 13px; 
            color: var(--gray-400); 
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-top: 4px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .contact-preview i { font-size: 11px; }

        .contact-meta { text-align: right; }
        .contact-time { font-size: 11px; color: var(--gray-500); }

        .contact-unread {
            min-width: 22px; height: 22px;
            background: var(--red);
            border-radius: 11px;
            font-size: 11px;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-top: 6px;
            margin-left: auto;
            padding: 0 6px;
        }

        /* CHAT AREA */
        .chat-area {
            display: flex;
            flex-direction: column;
            background: var(--black);
        }

        .chat-header {
            padding: 20px 30px;
            border-bottom: 1px solid var(--gray-700);
            display: flex;
            align-items: center;
            gap: 16px;
            background: var(--gray-900);
        }

        .chat-header-avatar {
            width: 46px; height: 46px;
            border-radius: 50%;
            background: linear-gradient(135deg, #E63946, #FF6B6B);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
        }

        .chat-header-info { flex: 1; }
        .chat-header-info h3 { font-size: 17px; font-weight: 700; }
        .chat-header-info p { font-size: 12px; color: var(--green); display: flex; align-items: center; gap: 6px; }
        .chat-header-info p i { font-size: 8px; }

        .chat-header-actions {
            display: flex;
            gap: 8px;
        }

        .header-action {
            width: 40px; height: 40px;
            border-radius: 10px;
            background: var(--gray-800);
            border: none;
            color: var(--gray-400);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .header-action:hover { background: var(--gray-700); color: var(--white); }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 30px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        /* DATE SEPARATOR */
        .date-separator {
            text-align: center;
            margin: 20px 0;
        }

        .date-separator span {
            background: var(--gray-800);
            padding: 6px 16px;
            border-radius: 20px;
            font-size: 12px;
            color: var(--gray-400);
        }

        /* MESSAGES */
        .message-wrapper {
            display: flex;
            flex-direction: column;
            max-width: 70%;
        }

        .message-wrapper.sent {
            align-self: flex-end;
            align-items: flex-end;
        }

        .message-wrapper.received {
            align-self: flex-start;
            align-items: flex-start;
        }

        .message {
            padding: 14px 18px;
            border-radius: 18px;
            font-size: 14px;
            line-height: 1.5;
            position: relative;
        }

        .message.received {
            background: var(--gray-800);
            border-bottom-left-radius: 6px;
        }

        .message.sent {
            background: var(--red);
            border-bottom-right-radius: 6px;
        }

        .message-footer {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-top: 6px;
            font-size: 11px;
            color: var(--gray-500);
        }

        .message-wrapper.sent .message-footer {
            color: rgba(255,255,255,0.5);
        }

        /* READ RECEIPTS */
        .read-receipt {
            display: flex;
            align-items: center;
        }

        .read-receipt i {
            font-size: 12px;
        }

        .read-receipt.sent { color: var(--gray-500); }
        .read-receipt.delivered { color: var(--gray-400); }
        .read-receipt.read { color: var(--blue); }

        /* MEDIA MESSAGES */
        .message-media {
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 8px;
            max-width: 280px;
        }

        .message-media img {
            width: 100%;
            display: block;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .message-media img:hover { transform: scale(1.02); }

        .message-media video {
            width: 100%;
            display: block;
            border-radius: 12px;
        }

        .message-file {
            display: flex;
            align-items: center;
            gap: 12px;
            background: var(--gray-700);
            padding: 12px 16px;
            border-radius: 12px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .message-file:hover { background: var(--gray-600); }

        .file-icon {
            width: 44px; height: 44px;
            border-radius: 10px;
            background: var(--red);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }

        .file-icon.pdf { background: #E53935; }
        .file-icon.doc { background: #1E88E5; }
        .file-icon.xls { background: #43A047; }

        .file-info { flex: 1; }
        .file-name { font-size: 13px; font-weight: 600; }
        .file-size { font-size: 11px; color: var(--gray-400); margin-top: 2px; }

        /* VOICE MESSAGE */
        .voice-message {
            display: flex;
            align-items: center;
            gap: 12px;
            min-width: 200px;
        }

        .voice-play {
            width: 36px; height: 36px;
            border-radius: 50%;
            background: var(--white);
            border: none;
            color: var(--red);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .voice-waveform {
            flex: 1;
            height: 30px;
            display: flex;
            align-items: center;
            gap: 2px;
        }

        .voice-bar {
            width: 3px;
            background: rgba(255,255,255,0.4);
            border-radius: 2px;
        }

        .voice-duration { font-size: 12px; color: rgba(255,255,255,0.6); }

        /* CHAT INPUT */
        .chat-input-area {
            padding: 16px 30px 24px;
            border-top: 1px solid var(--gray-700);
            background: var(--gray-900);
        }

        /* MEDIA PREVIEW */
        .media-preview {
            display: none;
            margin-bottom: 16px;
            background: var(--gray-800);
            border-radius: 12px;
            padding: 12px;
            position: relative;
        }

        .media-preview.show { display: flex; gap: 12px; flex-wrap: wrap; }

        .preview-item {
            position: relative;
            width: 80px; height: 80px;
            border-radius: 10px;
            overflow: hidden;
        }

        .preview-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .preview-item .remove-preview {
            position: absolute;
            top: 4px; right: 4px;
            width: 22px; height: 22px;
            border-radius: 50%;
            background: rgba(0,0,0,0.7);
            border: none;
            color: var(--white);
            cursor: pointer;
            font-size: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .preview-file {
            display: flex;
            align-items: center;
            gap: 10px;
            background: var(--gray-700);
            padding: 10px 14px;
            border-radius: 10px;
        }

        .preview-file i { font-size: 24px; color: var(--red); }
        .preview-file span { font-size: 13px; }

        .chat-input-box {
            display: flex;
            align-items: flex-end;
            gap: 12px;
        }

        .input-actions {
            display: flex;
            gap: 4px;
        }

        .input-action {
            width: 44px; height: 44px;
            border-radius: 12px;
            background: var(--gray-800);
            border: none;
            color: var(--gray-400);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            position: relative;
        }

        .input-action:hover { background: var(--gray-700); color: var(--white); }

        .input-action input[type="file"] {
            position: absolute;
            width: 100%;
            height: 100%;
            opacity: 0;
            cursor: pointer;
        }

        .message-input-wrapper {
            flex: 1;
            background: var(--gray-800);
            border: 1px solid var(--gray-600);
            border-radius: 24px;
            display: flex;
            align-items: flex-end;
            padding: 6px 6px 6px 20px;
            transition: border-color 0.2s;
        }

        .message-input-wrapper:focus-within { border-color: var(--red); }

        .message-input {
            flex: 1;
            background: none;
            border: none;
            color: var(--white);
            font-size: 14px;
            outline: none;
            resize: none;
            max-height: 120px;
            padding: 10px 0;
            font-family: inherit;
        }

        .send-btn {
            width: 40px; height: 40px;
            border-radius: 50%;
            background: var(--red);
            border: none;
            color: var(--white);
            font-size: 16px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .send-btn:hover { transform: scale(1.1); }
        .send-btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }

        /* EMPTY STATE */
        .empty-chat {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: var(--gray-500);
        }

        .empty-chat i { font-size: 80px; margin-bottom: 24px; opacity: 0.2; }
        .empty-chat h3 { font-size: 20px; color: var(--gray-400); margin-bottom: 8px; }
        .empty-chat p { font-size: 14px; }

        /* TYPING INDICATOR */
        .typing-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px 18px;
            background: var(--gray-800);
            border-radius: 18px;
            align-self: flex-start;
            margin-bottom: 16px;
        }

        .typing-dots {
            display: flex;
            gap: 4px;
        }

        .typing-dot {
            width: 8px; height: 8px;
            border-radius: 50%;
            background: var(--gray-500);
            animation: typingBounce 1.4s infinite ease-in-out;
        }

        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }

        @keyframes typingBounce {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-6px); }
        }

        /* IMAGE LIGHTBOX */
        .lightbox {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.95);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .lightbox.show { display: flex; }

        .lightbox img {
            max-width: 90%;
            max-height: 90%;
            border-radius: 8px;
        }

        .lightbox-close {
            position: absolute;
            top: 20px; right: 20px;
            width: 50px; height: 50px;
            border-radius: 50%;
            background: var(--gray-800);
            border: none;
            color: var(--white);
            font-size: 24px;
            cursor: pointer;
        }

        /* RESPONSIVE */
        @media (max-width: 900px) {
            .chat-container { grid-template-columns: 1fr; }
            .contacts { display: none; }
            .contacts.mobile-show {
                display: flex;
                position: fixed;
                inset: 0;
                bottom: 70px;
                z-index: 50;
                background: var(--gray-900);
            }
        }

        @media (max-width: 768px) {
            .sidebar { 
                position: fixed;
                left: 0;
                right: 0;
                bottom: 0;
                top: auto;
                width: 100%;
                height: 70px;
                flex-direction: row;
                padding: 0;
                justify-content: space-around;
                align-items: center;
                border-right: none;
                border-top: 1px solid var(--gray-700);
                background: var(--black);
            }
            .logo { display: none; }
            .nav-item { 
                margin-bottom: 0;
                width: 50px;
                height: 50px;
                font-size: 18px;
            }
            .nav-item.active::before { display: none; }
            .nav-spacer { display: none; }
            .chat-container { margin-left: 0; margin-bottom: 70px; height: calc(100vh - 70px); }
        }

        /* Mobile FAB */
        .mobile-fab {
            display: none;
            position: fixed;
            bottom: 86px;
            right: 16px;
            width: 56px;
            height: 56px;
            background: var(--red);
            border-radius: 50%;
            border: none;
            color: white;
            font-size: 20px;
            cursor: pointer;
            box-shadow: 0 4px 20px rgba(230,57,70,0.4);
            z-index: 40;
            align-items: center;
            justify-content: center;
        }
        
        @media (max-width: 900px) {
            .mobile-fab { display: flex; }
        }
        
        .contacts .close-mobile {
            display: none;
            position: absolute;
            top: 16px;
            right: 16px;
            width: 40px;
            height: 40px;
            background: var(--gray-700);
            border: none;
            border-radius: 50%;
            color: white;
            font-size: 18px;
            cursor: pointer;
            z-index: 60;
            align-items: center;
            justify-content: center;
        }
        
        @media (max-width: 900px) {
            .contacts .close-mobile { display: flex; }
        }
    </style>
</head>
<body>
    <nav class="sidebar">
        <a href="coach-dashboard.html" class="logo">GR</a>
        <a href="coach-dashboard.html" class="nav-item"><i class="fas fa-th-large"></i></a>
        <a href="coach-team.html" class="nav-item"><i class="fas fa-users"></i></a>
        <a href="coach-chat.html" class="nav-item active"><i class="fas fa-comments"></i></a>
        <a href="coach-generate.html" class="nav-item"><i class="fas fa-bolt"></i></a>
        <a href="coach-tests.html" class="nav-item"><i class="fas fa-stopwatch"></i></a>
        <a href="coach-review.html" class="nav-item"><i class="fas fa-clipboard-check"></i></a>
        <div class="nav-spacer"></div>
        <a href="#" onclick="coachLogout(event)" class="nav-item"><i class="fas fa-sign-out-alt"></i></a>
    </nav>

    <!-- Mobile FAB - outside containers -->
    <button class="mobile-fab" onclick="toggleContacts()">
        <i class="fas fa-users"></i>
    </button>

    <div class="chat-container">
        <div class="contacts" id="contacts">
            <button class="close-mobile" onclick="toggleContacts()">
                <i class="fas fa-times"></i>
            </button>
            <div class="contacts-header">
                <h2>Chat <span id="unread-total">0</span></h2>
                <div class="search-box">
                    <i class="fas fa-search"></i>
                    <input type="text" placeholder="Cerca atleta..." id="search-input">
                </div>
                <div class="filters">
                    <button class="filter-btn active" data-filter="all">Tutti</button>
                    <button class="filter-btn" data-filter="unread">Non letti</button>
                </div>
            </div>
            <div class="contacts-list" id="contacts-list"></div>
        </div>

        <div class="chat-area" id="chat-area">
            <div class="empty-chat">
                <i class="fas fa-comments"></i>
                <h3>I tuoi messaggi</h3>
                <p>Seleziona un atleta per iniziare a chattare</p>
            </div>
        </div>
    </div>

    <!-- LIGHTBOX -->
    <div class="lightbox" id="lightbox" onclick="closeLightbox()">
        <button class="lightbox-close"><i class="fas fa-times"></i></button>
        <img id="lightbox-img" src="">
    </div>

    <script src="js/supabase-client.js"></script>
    <script>
        // Check if coach is logged in
        if (localStorage.getItem('gr_coach_logged_in') !== 'true') {
            window.location.href = 'coach-login.html';
        }

        // Logout function
        function coachLogout(event) {
            if (event) event.preventDefault();
            localStorage.removeItem('gr_coach_logged_in');
            localStorage.removeItem('gr_coach_email');
            localStorage.removeItem('gr_coach_name');
            localStorage.removeItem('gr_coach_last_active');
            window.location.replace('coach-login.html');
        }
        let athletes = [];
        let selectedAthleteId = null;
        let unreadMap = {};
        let currentFilter = 'all';
        let pendingMedia = [];
        
        // Toggle contacts panel on mobile
        function toggleContacts() {
            const contacts = document.getElementById('contacts');
            contacts.classList.toggle('mobile-show');
        }

        document.addEventListener('DOMContentLoaded', async () => {
            athletes = await supabase.fetch('athletes', '?select=*');
            await loadUnreadCounts();
            renderContacts(athletes);

            document.getElementById('search-input').addEventListener('input', applyFilters);

            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    currentFilter = btn.dataset.filter;
                    applyFilters();
                });
            });

            // Check URL params for athlete
            const urlParams = new URLSearchParams(window.location.search);
            const athleteId = urlParams.get('athlete');
            if (athleteId) selectAthlete(athleteId);
        });

        async function loadUnreadCounts() {
            let total = 0;
            for (const a of athletes) {
                const unread = await supabase.fetch('chat_messages',
                    `?athlete_id=eq.${a.id}&sender=eq.athlete&read=eq.false&select=id`
                );
                unreadMap[a.id] = unread.length;
                total += unread.length;
            }
            document.getElementById('unread-total').textContent = total;
        }

        function applyFilters() {
            const searchQuery = document.getElementById('search-input').value.toLowerCase();
            
            let filtered = athletes.filter(a => {
                const name = `${a.first_name} ${a.last_name}`.toLowerCase();
                const matchesSearch = name.includes(searchQuery);
                const matchesUnread = currentFilter !== 'unread' || (unreadMap[a.id] || 0) > 0;
                return matchesSearch && matchesUnread;
            });

            renderContacts(filtered);
        }

        async function renderContacts(list) {
            const container = document.getElementById('contacts-list');
            
            const contactsHtml = await Promise.all(list.map(async a => {
                const messages = await supabase.fetch('chat_messages', 
                    `?athlete_id=eq.${a.id}&select=*&order=created_at.desc&limit=1`
                );
                const lastMsg = messages[0];
                const unreadCount = unreadMap[a.id] || 0;
                
                const initials = (a.first_name?.[0] || '') + (a.last_name?.[0] || '');
                const time = lastMsg ? formatTime(lastMsg.created_at) : '';
                
                let preview = 'Nessun messaggio';
                let previewIcon = '';
                if (lastMsg) {
                    if (lastMsg.media_type === 'image') {
                        previewIcon = '<i class="fas fa-image"></i>';
                        preview = 'Foto';
                    } else if (lastMsg.media_type === 'video') {
                        previewIcon = '<i class="fas fa-video"></i>';
                        preview = 'Video';
                    } else if (lastMsg.media_type === 'file') {
                        previewIcon = '<i class="fas fa-file"></i>';
                        preview = 'File';
                    } else if (lastMsg.media_type === 'voice') {
                        previewIcon = '<i class="fas fa-microphone"></i>';
                        preview = 'Messaggio vocale';
                    } else {
                        preview = lastMsg.message?.substring(0, 35) + (lastMsg.message?.length > 35 ? '...' : '');
                    }
                }
                
                return `
                    <div class="contact-item ${selectedAthleteId === a.id ? 'active' : ''}" onclick="selectAthlete('${a.id}')">
                        <div class="contact-avatar online">${initials}</div>
                        <div class="contact-info">
                            <div class="contact-name">${a.first_name} ${a.last_name}</div>
                            <div class="contact-preview">${previewIcon} ${preview}</div>
                        </div>
                        <div class="contact-meta">
                            <div class="contact-time">${time}</div>
                            ${unreadCount > 0 ? `<div class="contact-unread">${unreadCount}</div>` : ''}
                        </div>
                    </div>
                `;
            }));
            
            container.innerHTML = contactsHtml.join('') || '<div style="padding: 24px; color: var(--gray-500); text-align: center;">Nessun atleta trovato</div>';
        }

        function formatTime(dateStr) {
            const date = new Date(dateStr);
            const now = new Date();
            const diff = now - date;
            
            if (diff < 86400000 && date.getDate() === now.getDate()) {
                return date.toLocaleTimeString('it-IT', { hour: '2-digit', minute: '2-digit' });
            } else if (diff < 172800000) {
                return 'Ieri';
            } else {
                return date.toLocaleDateString('it-IT', { day: '2-digit', month: '2-digit' });
            }
        }

        async function selectAthlete(id) {
            selectedAthleteId = id;
            const athlete = athletes.find(a => a.id === id);
            
            // Mark as read
            await fetch(`https://unkzjnlrorluzfahmize.supabase.co/rest/v1/chat_messages?athlete_id=eq.${id}&sender=eq.athlete&read=eq.false`, {
                method: 'PATCH',
                headers: {
                    'apikey': 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVua3pqbmxyb3JsdXpmYWhtaXplIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU3OTQ3MTIsImV4cCI6MjA4MTM3MDcxMn0.c1utLN0YO2k6K-8cFokp7LaTD2ND6Mb0l2BxeFW4oxM',
                    'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVua3pqbmxyb3JsdXpmYWhtaXplIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU3OTQ3MTIsImV4cCI6MjA4MTM3MDcxMn0.c1utLN0YO2k6K-8cFokp7LaTD2ND6Mb0l2BxeFW4oxM',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ read: true })
            });

            unreadMap[id] = 0;
            await loadUnreadCounts();

            const messages = await supabase.fetch('chat_messages', 
                `?athlete_id=eq.${id}&select=*&order=created_at.asc`
            );

            const initials = (athlete.first_name?.[0] || '') + (athlete.last_name?.[0] || '');
            
            document.getElementById('chat-area').innerHTML = `
                <div class="chat-header">
                    <div class="chat-header-avatar">${initials}</div>
                    <div class="chat-header-info">
                        <h3>${athlete.first_name} ${athlete.last_name}</h3>
                        <p><i class="fas fa-circle"></i> Online ora</p>
                    </div>
                    <div class="chat-header-actions">
                        <button class="header-action" onclick="location.href='athlete-profile.html?id=${id}'" title="Vedi Profilo"><i class="fas fa-user"></i></button>
                        <button class="header-action" onclick="callAthlete('${athlete.phone || ''}')" title="Chiama"><i class="fas fa-phone"></i></button>
                        <button class="header-action" onclick="location.href='coach-generate.html?athlete=${id}'" title="Genera Workout"><i class="fas fa-bolt"></i></button>
                        <button class="header-action" onclick="toggleChatMenu()" title="Altro"><i class="fas fa-ellipsis-v"></i></button>
                    </div>
                </div>
                <div class="chat-messages" id="messages">
                    ${renderMessages(messages)}
                </div>
                <div class="chat-input-area">
                    <div class="media-preview" id="media-preview"></div>
                    <div class="chat-input-box">
                        <div class="input-actions">
                            <button class="input-action" title="Allega file">
                                <i class="fas fa-paperclip"></i>
                                <input type="file" id="file-input" accept=".pdf,.doc,.docx,.xls,.xlsx" onchange="handleFileSelect(event)">
                            </button>
                            <button class="input-action" title="Invia foto">
                                <i class="fas fa-image"></i>
                                <input type="file" id="image-input" accept="image/*" multiple onchange="handleImageSelect(event)">
                            </button>
                            <button class="input-action" title="Invia video">
                                <i class="fas fa-video"></i>
                                <input type="file" id="video-input" accept="video/*" onchange="handleVideoSelect(event)">
                            </button>
                        </div>
                        <div class="message-input-wrapper">
                            <textarea class="message-input" id="message-input" placeholder="Scrivi un messaggio..." rows="1" onkeypress="handleKeyPress(event)" oninput="autoResize(this)"></textarea>
                            <button class="send-btn" onclick="sendMessage()"><i class="fas fa-paper-plane"></i></button>
                        </div>
                    </div>
                </div>
            `;

            document.getElementById('messages').scrollTop = document.getElementById('messages').scrollHeight;
            renderContacts(athletes);
        }

        function renderMessages(messages) {
            let html = '';
            let lastDate = '';

            messages.forEach(m => {
                const msgDate = new Date(m.created_at).toLocaleDateString('it-IT', { day: 'numeric', month: 'long' });
                if (msgDate !== lastDate) {
                    html += `<div class="date-separator"><span>${msgDate}</span></div>`;
                    lastDate = msgDate;
                }

                const isSent = m.sender === 'coach';
                const time = new Date(m.created_at).toLocaleTimeString('it-IT', { hour: '2-digit', minute: '2-digit' });
                
                // Read receipt status
                let receiptClass = 'sent';
                if (m.delivered) receiptClass = 'delivered';
                if (m.read) receiptClass = 'read';
                
                let mediaHtml = '';
                if (m.media_type === 'image' && m.media_url) {
                    mediaHtml = `<div class="message-media"><img src="${m.media_url}" onclick="openLightbox('${m.media_url}')"></div>`;
                } else if (m.media_type === 'video' && m.media_url) {
                    mediaHtml = `<div class="message-media"><video controls src="${m.media_url}"></video></div>`;
                } else if (m.media_type === 'file' && m.media_url) {
                    const ext = m.file_name?.split('.').pop() || 'pdf';
                    mediaHtml = `
                        <div class="message-file" onclick="window.open('${m.media_url}')">
                            <div class="file-icon ${ext}"><i class="fas fa-file-${ext === 'pdf' ? 'pdf' : 'alt'}"></i></div>
                            <div class="file-info">
                                <div class="file-name">${m.file_name || 'Documento'}</div>
                                <div class="file-size">${m.file_size || 'PDF'}</div>
                            </div>
                            <i class="fas fa-download" style="color: var(--gray-400);"></i>
                        </div>
                    `;
                } else if (m.media_type === 'voice') {
                    mediaHtml = `
                        <div class="voice-message">
                            <button class="voice-play"><i class="fas fa-play"></i></button>
                            <div class="voice-waveform">
                                ${Array(20).fill().map(() => `<div class="voice-bar" style="height: ${Math.random() * 20 + 10}px;"></div>`).join('')}
                            </div>
                            <span class="voice-duration">${m.voice_duration || '0:00'}</span>
                        </div>
                    `;
                }

                html += `
                    <div class="message-wrapper ${isSent ? 'sent' : 'received'}">
                        <div class="message ${isSent ? 'sent' : 'received'}">
                            ${mediaHtml}
                            ${m.message ? m.message : ''}
                        </div>
                        <div class="message-footer">
                            <span>${time}</span>
                            ${isSent ? `
                                <span class="read-receipt ${receiptClass}">
                                    <i class="fas fa-check${m.read ? '-double' : ''}"></i>
                                </span>
                            ` : ''}
                        </div>
                    </div>
                `;
            });

            return html || '<div style="text-align: center; color: var(--gray-500); padding: 40px;">Inizia la conversazione</div>';
        }

        function handleKeyPress(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        }

        function autoResize(el) {
            el.style.height = 'auto';
            el.style.height = Math.min(el.scrollHeight, 120) + 'px';
        }

        function handleImageSelect(e) {
            const files = Array.from(e.target.files);
            files.forEach(file => {
                const reader = new FileReader();
                reader.onload = (ev) => {
                    pendingMedia.push({ type: 'image', url: ev.target.result, file });
                    updateMediaPreview();
                };
                reader.readAsDataURL(file);
            });
        }

        function handleVideoSelect(e) {
            const file = e.target.files[0];
            if (file) {
                const url = URL.createObjectURL(file);
                pendingMedia.push({ type: 'video', url, file });
                updateMediaPreview();
            }
        }

        function handleFileSelect(e) {
            const file = e.target.files[0];
            if (file) {
                pendingMedia.push({ type: 'file', name: file.name, file });
                updateMediaPreview();
            }
        }

        function updateMediaPreview() {
            const preview = document.getElementById('media-preview');
            if (!pendingMedia.length) {
                preview.classList.remove('show');
                preview.innerHTML = '';
                return;
            }

            preview.classList.add('show');
            preview.innerHTML = pendingMedia.map((m, i) => {
                if (m.type === 'image') {
                    return `
                        <div class="preview-item">
                            <img src="${m.url}">
                            <button class="remove-preview" onclick="removePendingMedia(${i})"><i class="fas fa-times"></i></button>
                        </div>
                    `;
                } else if (m.type === 'video') {
                    return `
                        <div class="preview-item" style="background: var(--gray-700); display: flex; align-items: center; justify-content: center;">
                            <i class="fas fa-video" style="font-size: 24px;"></i>
                            <button class="remove-preview" onclick="removePendingMedia(${i})"><i class="fas fa-times"></i></button>
                        </div>
                    `;
                } else {
                    return `
                        <div class="preview-file">
                            <i class="fas fa-file-pdf"></i>
                            <span>${m.name}</span>
                            <button class="remove-preview" onclick="removePendingMedia(${i})" style="position: static; margin-left: auto;"><i class="fas fa-times"></i></button>
                        </div>
                    `;
                }
            }).join('');
        }

        function removePendingMedia(index) {
            pendingMedia.splice(index, 1);
            updateMediaPreview();
        }

        async function sendMessage() {
            const input = document.getElementById('message-input');
            const message = input.value.trim();
            
            if (!message && !pendingMedia.length) return;
            if (!selectedAthleteId) return;

            input.value = '';
            input.style.height = 'auto';

            // Send text message
            if (message) {
                await supabase.insert('chat_messages', {
                    athlete_id: selectedAthleteId,
                    sender: 'coach',
                    message: message,
                    read: false,
                    delivered: true
                });
            }

            // Send media messages
            for (const media of pendingMedia) {
                // In a real app, upload to storage first
                // For demo, we'll save with placeholder URL
                await supabase.insert('chat_messages', {
                    athlete_id: selectedAthleteId,
                    sender: 'coach',
                    message: '',
                    media_type: media.type,
                    media_url: media.url || null,
                    file_name: media.name || null,
                    read: false,
                    delivered: true
                });
            }

            pendingMedia = [];
            updateMediaPreview();
            selectAthlete(selectedAthleteId);
        }

        function openLightbox(url) {
            document.getElementById('lightbox-img').src = url;
            document.getElementById('lightbox').classList.add('show');
        }

        function closeLightbox() {
            document.getElementById('lightbox').classList.remove('show');
        }

        // Call athlete function
        function callAthlete(phone) {
            if (phone && phone.trim()) {
                // Open phone dialer
                window.location.href = `tel:${phone}`;
            } else {
                alert('Numero di telefono non disponibile per questo atleta');
            }
        }

        // Toggle chat menu (placeholder for future options)
        function toggleChatMenu() {
            // Could show options like: Archivia chat, Cerca messaggi, Esporta chat, etc.
            alert('Menu opzioni in arrivo: Archivia, Cerca, Esporta...');
        }

        // Poll for new messages
        setInterval(async () => {
            if (selectedAthleteId) {
                const messages = await supabase.fetch('chat_messages', 
                    `?athlete_id=eq.${selectedAthleteId}&select=*&order=created_at.asc`
                );
                document.getElementById('messages').innerHTML = renderMessages(messages);
            }
        }, 5000);
    </script>
</body>
</html>
