<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Dual AI - Groq + Gemini</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #0a0a0a; color: #e5e5e5; padding: 20px; line-height: 1.6; }
        h1 { color: #fff; margin-bottom: 20px; }
        .container { max-width: 1000px; margin: 0 auto; }
        
        .status-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px; }
        .status-card { background: #1a1a1a; border-radius: 12px; padding: 20px; }
        .status-card h3 { margin-bottom: 10px; display: flex; align-items: center; gap: 10px; }
        .status-indicator { width: 12px; height: 12px; border-radius: 50%; }
        .status-indicator.pending { background: #666; }
        .status-indicator.success { background: #22c55e; }
        .status-indicator.error { background: #ef4444; }
        
        .mode-selector { margin-bottom: 20px; }
        .mode-selector label { display: block; margin-bottom: 8px; color: #888; }
        .mode-selector select { width: 100%; padding: 12px; background: #1a1a1a; border: 1px solid #333; border-radius: 8px; color: #fff; font-size: 1rem; }
        
        .btn { background: linear-gradient(135deg, #22c55e, #16a34a); color: #fff; border: none; padding: 14px 28px; border-radius: 8px; font-size: 1rem; cursor: pointer; margin-right: 10px; margin-bottom: 10px; }
        .btn:hover { transform: translateY(-2px); }
        .btn.secondary { background: linear-gradient(135deg, #3b82f6, #1d4ed8); }
        .btn.purple { background: linear-gradient(135deg, #9333ea, #7c3aed); }
        
        .test-result { background: #1a1a1a; border-radius: 12px; padding: 16px; margin-bottom: 12px; border-left: 4px solid #333; }
        .test-result.pass { border-left-color: #22c55e; }
        .test-result.warn { border-left-color: #f59e0b; }
        .test-result.fail { border-left-color: #ef4444; }
        .test-title { font-weight: 600; margin-bottom: 8px; display: flex; align-items: center; gap: 8px; }
        .test-data { font-family: 'Fira Code', monospace; font-size: 0.85rem; background: #0d0d0d; padding: 12px; border-radius: 8px; white-space: pre-wrap; overflow-x: auto; max-height: 400px; overflow-y: auto; }
        
        .stats-bar { display: flex; gap: 20px; margin-bottom: 20px; flex-wrap: wrap; }
        .stat-item { background: #1a1a1a; padding: 12px 20px; border-radius: 8px; }
        .stat-value { font-size: 1.5rem; font-weight: 700; color: #22c55e; }
        .stat-label { font-size: 0.85rem; color: #888; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ü§ñ Test Dual AI - Groq + Gemini</h1>
        
        <div class="status-grid">
            <div class="status-card">
                <h3>
                    <span class="status-indicator pending" id="groq-status"></span>
                    Groq (Llama 3.3)
                </h3>
                <div id="groq-info">Testing...</div>
            </div>
            <div class="status-card">
                <h3>
                    <span class="status-indicator pending" id="gemini-status"></span>
                    Gemini (2.0 Flash)
                </h3>
                <div id="gemini-info">Testing...</div>
            </div>
        </div>
        
        <div class="mode-selector">
            <label>Modalit√† Collaborazione AI</label>
            <select id="mode-select" onchange="changeMode(this.value)">
                <option value="groq_gen_gemini_val">üîÑ Groq genera ‚Üí Gemini valida (consigliato)</option>
                <option value="gemini_gen_groq_val">üîÑ Gemini genera ‚Üí Groq valida</option>
                <option value="parallel_consensus">‚ö° Parallelo con consensus</option>
                <option value="fallback">üõ°Ô∏è Fallback automatico</option>
                <option value="groq_only">üü¢ Solo Groq</option>
                <option value="gemini_only">üîµ Solo Gemini</option>
            </select>
        </div>
        
        <div class="stats-bar" id="stats-bar">
            <div class="stat-item">
                <div class="stat-value" id="stat-groq">0</div>
                <div class="stat-label">Groq calls</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="stat-gemini">0</div>
                <div class="stat-label">Gemini calls</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="stat-improvements">0</div>
                <div class="stat-label">Improvements</div>
            </div>
        </div>
        
        <div style="margin-bottom: 20px;">
            <button class="btn" onclick="testConnections()">üîå Test Connessioni</button>
            <button class="btn secondary" onclick="testWorkoutGeneration()">üí™ Test Workout Generation</button>
            <button class="btn purple" onclick="testComparison()">‚öîÔ∏è Confronto Groq vs Gemini</button>
        </div>
        
        <div id="results"></div>
    </div>

    <script src="js/dual-ai.js?v=11"></script>
    <script>
        const resultsDiv = document.getElementById('results');
        
        function log(title, data, status = 'pass') {
            const div = document.createElement('div');
            div.className = `test-result ${status}`;
            const icon = status === 'pass' ? '‚úÖ' : status === 'warn' ? '‚ö†Ô∏è' : '‚ùå';
            div.innerHTML = `
                <div class="test-title">${icon} ${title}</div>
                <div class="test-data">${typeof data === 'string' ? data : JSON.stringify(data, null, 2)}</div>
            `;
            resultsDiv.insertBefore(div, resultsDiv.firstChild);
            updateStats();
        }

        function updateStats() {
            const stats = window.DualAI.getStats();
            document.getElementById('stat-groq').textContent = stats.groqCalls;
            document.getElementById('stat-gemini').textContent = stats.geminiCalls;
            document.getElementById('stat-improvements').textContent = stats.validationImprovements;
        }

        function changeMode(mode) {
            window.DualAI.setMode(mode);
            log('Mode Changed', `Modalit√†: ${mode}`, 'pass');
        }

        async function testConnections() {
            log('üîå Testing connections...', 'In corso...', 'warn');
            
            try {
                const results = await window.DualAI.testConnections();
                
                // Update UI
                document.getElementById('groq-status').className = 
                    'status-indicator ' + (results.groq ? 'success' : 'error');
                document.getElementById('groq-info').textContent = 
                    results.groq ? '‚úÖ Connesso' : '‚ùå ' + (results.groqError || 'Errore');
                
                document.getElementById('gemini-status').className = 
                    'status-indicator ' + (results.gemini ? 'success' : 'error');
                document.getElementById('gemini-info').textContent = 
                    results.gemini ? '‚úÖ Connesso' : '‚ùå ' + (results.geminiError || 'Errore');
                
                log('üîå Test Connessioni', {
                    groq: results.groq ? 'OK ‚úÖ' : 'FAILED ‚ùå - ' + results.groqError,
                    gemini: results.gemini ? 'OK ‚úÖ' : 'FAILED ‚ùå - ' + results.geminiError
                }, results.groq && results.gemini ? 'pass' : 'fail');
                
            } catch (err) {
                log('‚ùå Errore Test', err.message, 'fail');
            }
        }

        async function testWorkoutGeneration() {
            log('üí™ Generazione workout...', 'In corso...', 'warn');
            
            const prompt = `
Genera UN workout per un pugile intermedio, sessione di forza.
Fase: Accumulo
Pain areas: ginocchio sinistro (evitare squat pesanti)
Readiness: 75%

Output SOLO JSON:
{
    "name": "Nome sessione",
    "exercises": [
        {"name": "...", "sets": 3, "reps": "8-10", "rest": "90s", "notes": "..."}
    ]
}`;

            try {
                const start = Date.now();
                const result = await window.DualAI.generateWorkout(prompt, 'Pugile, ginocchio dolorante');
                const duration = Date.now() - start;
                
                log('üí™ Workout Generato', {
                    provider: result.provider,
                    model: result.model,
                    validated: result.validated || false,
                    validator: result.validator || 'none',
                    duration: duration + 'ms',
                    mode: result.mode,
                    content: result.content.slice(0, 500) + (result.content.length > 500 ? '...' : '')
                }, 'pass');
                
            } catch (err) {
                log('‚ùå Errore Generazione', err.message, 'fail');
            }
        }

        async function testComparison() {
            log('‚öîÔ∏è Confronto AI...', 'Chiamando entrambe le AI in parallelo...', 'warn');
            
            const prompt = `Genera 3 esercizi per riscaldamento spalle. Output JSON array: [{"name":"...", "sets":2, "reps":"10"}]`;
            
            try {
                const start = Date.now();
                
                const [groqResult, geminiResult] = await Promise.allSettled([
                    window.DualAI.callGroq({
                        messages: [
                            { role: 'system', content: 'Rispondi SOLO in JSON.' },
                            { role: 'user', content: prompt }
                        ],
                        model: 'fast',
                        maxTokens: 300
                    }),
                    window.DualAI.callGemini({
                        messages: [
                            { role: 'system', content: 'Rispondi SOLO in JSON.' },
                            { role: 'user', content: prompt }
                        ],
                        model: 'fast',
                        maxTokens: 300
                    })
                ]);
                
                const duration = Date.now() - start;
                
                log('‚öîÔ∏è Confronto Completato', {
                    duration: duration + 'ms',
                    groq: {
                        status: groqResult.status,
                        model: groqResult.value?.model || 'N/A',
                        content: groqResult.value?.content?.slice(0, 300) || groqResult.reason?.message
                    },
                    gemini: {
                        status: geminiResult.status,
                        model: geminiResult.value?.model || 'N/A',
                        content: geminiResult.value?.content?.slice(0, 300) || geminiResult.reason?.message
                    }
                }, groqResult.status === 'fulfilled' && geminiResult.status === 'fulfilled' ? 'pass' : 'warn');
                
            } catch (err) {
                log('‚ùå Errore Confronto', err.message, 'fail');
            }
        }

        // Auto-test on load
        window.addEventListener('load', () => {
            setTimeout(testConnections, 500);
        });
    </script>
</body>
</html>
